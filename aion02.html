<!DOCTYPE html>
<html lang="zh-Hant-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Aion2 é«˜éšè§£æ - è§’è‰²åç¨±å¿«é€ŸæŸ¥è©¢ç‰ˆ</title>


    <style>
        /* ä¿ç•™ä½ åŸæœ¬çš„æ‰€æœ‰ CSS æ¨£å¼ */
        :root {
            /* ğŸ¨ ç¾ä»£æ·±è‰²ä¸»é¡Œé…è‰² */
            --bg: #0a0e17;
            --bg-secondary: #0f1419;
            --panel: #151b26;
            --panel-elevated: #1a2332;
            --border: #2d3748;
            --border-bright: #4a5568;

            /* ğŸŒŸ ä¸»è¦å“ç‰Œè‰² - éœ“è™¹è—é‡‘æ¼¸è®Š */
            --primary: #00d4ff;
            --primary-dark: #0099cc;
            --primary-glow: rgba(0, 212, 255, 0.3);

            /* ğŸ’ é‡‘è‰²ç³» - æ›´äº®çœ¼çš„è³½åšé‡‘ */
            --gold: #ffd93d;
            --gold-bright: #ffe66d;
            --gold-dark: #d4af37;
            --gold-glow: rgba(255, 217, 61, 0.3);

            /* ğŸ”µ è—è‰²ç³» - é›»å…‰è— */
            --blue: #00d4ff;
            --blue-bright: #33ddff;
            --blue-dark: #0099cc;
            --blue-glow: rgba(0, 212, 255, 0.25);

            /* ğŸŸ¢ ç¶ è‰²ç³» - éœ“è™¹ç¶  */
            --green: #00ff88;
            --green-bright: #33ffaa;
            --green-glow: rgba(0, 255, 136, 0.25);

            /* ğŸ® éŠæˆ²é™£ç‡Ÿè‰² - æ›´é®®è±” */
            --nezakan: #ff4757;
            --zikel: #7bed9f;
            --triniel: #70a1ff;
            --ariel: #ffa502;
            --asphel: #d63aff;
            --baizel: #ff6348;
            --arcana: #1dd1a1;

            /* ğŸŒˆ æ¼¸è®ŠèƒŒæ™¯ */
            --profile-bg: linear-gradient(135deg, #1a2332 0%, #0f1922 50%, #0a0e17 100%);
            --card-bg: linear-gradient(145deg, rgba(26, 35, 50, 0.6), rgba(15, 25, 34, 0.4));
            --accent-gradient: linear-gradient(135deg, var(--primary), var(--gold));
            --glow-gradient: radial-gradient(circle at center, var(--primary-glow), transparent);
        }

        body {
            background: var(--bg);
            color: #e6edf3;
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            margin: 0;
            padding: 15px;
            font-size: 15px;
        }

        .container {
            max-width: 1400px;
            margin: auto;
        }

        /* å¼·åŒ–å¾Œçš„åŒ¯å…¥å€å¡Š */
        .input-area {
            background: var(--card-bg);
            border: 2px solid var(--gold);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6),
                0 0 40px var(--gold-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .input-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: var(--glow-gradient);
            opacity: 0.05;
            animation: rotate 20s linear infinite;
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .import-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .api-input-group input,
        .api-input-group select {
            background: rgba(10, 14, 23, 0.8);
            border: 2px solid var(--border);
            color: var(--blue-bright);
            padding: 12px 16px;
            border-radius: 8px;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }

        .api-input-group input:focus,
        .api-input-group select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow),
                0 0 20px var(--blue-glow);
            background: rgba(10, 14, 23, 1);
        }

        #charNameInput {
            flex: 2;
            min-width: 200px;
        }

        #serverSelect {
            flex: 1;
            min-width: 120px;
        }

        .import-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        textarea {
            width: 90%;
            height: 80px;
            background: rgba(10, 14, 23, 0.8);
            border: 2px solid var(--border);
            color: var(--blue-bright);
            padding: 12px;
            border-radius: 8px;
            font-family: 'Consolas', 'Monaco', monospace;
            resize: vertical;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-glow),
                0 0 20px var(--blue-glow);
            background: rgba(10, 14, 23, 1);
        }

        input[type="file"] {
            display: none;
        }

        .file-label {
            background: linear-gradient(135deg, var(--panel-elevated), var(--panel));
            color: var(--blue-bright);
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid var(--border);
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .file-label::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .file-label:hover {
            background: linear-gradient(135deg, var(--panel-elevated), var(--border));
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4),
                0 0 20px var(--blue-glow);
        }

        .file-label:hover::before {
            width: 300px;
            height: 300px;
        }

        .file-label:active {
            transform: translateY(0);
        }

        .btn-api {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: 2px solid var(--primary);
            padding: 0 30px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            min-height: 45px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .btn-api::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn-api:hover {
            background: linear-gradient(135deg, var(--blue-bright), var(--primary));
            border-color: var(--blue-bright);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--blue-glow),
                0 0 30px var(--primary-glow);
        }

        .btn-api:hover::before {
            left: 100%;
        }

        .btn-api:active {
            transform: translateY(0);
        }

        button#parseBtn {
            background: linear-gradient(135deg, var(--gold), var(--gold-dark));
            color: #0a0e17;
            border: 2px solid var(--gold-bright);
            padding: 12px 40px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        button#parseBtn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        button#parseBtn:hover {
            background: linear-gradient(135deg, var(--gold-bright), var(--gold));
            border-color: var(--gold-bright);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 30px var(--gold-glow),
                0 0 40px var(--gold-glow);
        }

        button#parseBtn:hover::after {
            width: 400px;
            height: 400px;
        }

        button#parseBtn:active {
            transform: translateY(-1px) scale(1);
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            color: var(--gold);
            font-size: 24px;
        }


        /* å„€è¡¨æ¿æ¨£å¼ */
        .dashboard {
            display: none;
            flex-direction: column;
            gap: 20px;
        }

        .profile-card {
            background: var(--profile-bg);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.7),
                0 0 40px var(--gold-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .profile-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 212, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {

            0%,
            100% {
                left: -100%;
            }

            50% {
                left: 100%;
            }
        }

        .profile-img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid var(--gold);
            padding: 3px;
            background: linear-gradient(135deg, var(--gold), var(--primary));
            box-shadow: 0 0 30px var(--gold-glow);
        }

        .profile-name {
            font-size: 32px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 20px var(--gold-glow));
        }

        .rank-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .rank-badge {
            background: linear-gradient(145deg, rgba(26, 35, 50, 0.6), rgba(15, 25, 34, 0.4));
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 10px 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 160px;
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .rank-badge:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 15px var(--blue-glow);
            transform: translateY(-2px);
        }

        .rank-badge img {
            width: 32px;
            height: 32px;
        }

        .rank-info {
            display: flex;
            flex-direction: column;
        }

        .rank-title {
            font-size: 14px;
            color: #f1eae8;
        }

        .rank-val {
            font-weight: bold;
            font-size: 14px;
            color: var(--gold-bright);
            text-shadow: 0 0 10px var(--gold-glow);
        }

        .rank-change {
            font-size: 10px;
            margin-left: 5px;
        }

        .up {
            color: #ff6c6c;
        }

        .down {
            color: #3fb950;
        }

        .card {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            margin-bottom: 20px;
            position: relative;
        }

        h3 {
            color: var(--gold-bright);
            margin: 0 0 15px 0;
            font-size: 19px;
            border-left: 5px solid var(--gold);
            padding-left: 12px;
            text-shadow: 0 0 20px var(--gold-glow);
            font-weight: 700;
        }

        .sk-label {
            font-size: 14px;
            color: var(--blue-bright);
            margin-bottom: 12px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
        }

        .stat-grid-main {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 10px;
            align-items: stretch;
        }

        .stat-mini-card {
            background: linear-gradient(145deg, rgba(26, 35, 50, 0.5), rgba(15, 25, 34, 0.3));
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            position: relative;
            cursor: help;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 80px;
        }

        .stat-mini-card:hover {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(0, 212, 255, 0.05));
            transform: translateY(-5px) scale(1.03);
            z-index: 100;
            border-color: var(--primary);
            box-shadow: 0 12px 35px var(--blue-glow),
                0 0 30px var(--primary-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .stat-mini-val {
            display: block;
            font-size: 24px;
            font-weight: 800;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-top: 5px;
            filter: drop-shadow(0 0 10px var(--gold-glow));
        }

        .main-layout-wrapper {
            align-items: flex-start;
        }

        .skill-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 8px;
            margin-bottom: 25px;
        }

        .skill-card {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: linear-gradient(145deg, rgba(26, 35, 50, 0.4), rgba(15, 25, 34, 0.2));
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: help;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(5px);
        }

        .skill-card:hover {
            background: linear-gradient(135deg, rgba(255, 217, 61, 0.2), rgba(255, 217, 61, 0.05));
            border-color: var(--gold);
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px var(--gold-glow),
                0 0 20px var(--gold-glow);
        }

        .skill-card:hover img {
            transform: scale(1.1) rotate(3deg);
            box-shadow: 0 4px 15px rgba(212, 180, 131, 0.5);
        }

        .skill-card img {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .skill-card img {
            width: 34px;
            height: 34px;
            border-radius: 6px;
            border: 2px solid var(--gold);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px var(--gold-glow);
        }

        .sk-name {
            font-size: 12px;
            font-weight: 700;
            color: var(--blue-bright);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 80px;
            text-shadow: 0 0 10px var(--blue-glow);
        }

        .tooltip {
            visibility: hidden;
            min-width: 180px;
            max-width: min(350px, calc(100vw - 40px));
            width: max-content;
            /* ğŸ’ ç¾ä»£åŒ–æ·±è‰²è³ªæ„Ÿé…è‰² */
            background: linear-gradient(145deg, rgba(26, 35, 50, 0.98), rgba(15, 25, 34, 0.98)) !important;
            backdrop-filter: blur(20px) saturate(180%);
            /* å¼·åŒ–ç£¨ç ‚ç»ç’ƒæ•ˆæœ */
            border: 2px solid rgba(0, 212, 255, 0.3);
            border-top: 3px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            position: absolute;
            z-index: 9999 !important;
            /* é¡¯ç¤ºä½ç½® */
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            opacity: 0;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            /* æŸ”å’Œæ·±é‚ƒé™°å½± + éœ“è™¹å…‰æšˆ */
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.9),
                0 0 30px var(--primary-glow),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: #e8f0ff !important;
            pointer-events: none;
            white-space: normal;
            font-size: 13px;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Tooltip å…§éƒ¨çš„æ¨™é¡Œæ¨£å¼å„ªåŒ– */
        .tooltip b {
            color: var(--gold-bright) !important;
            letter-spacing: 0.5px;
            text-shadow: 0 0 10px var(--gold-glow);
        }

        /* è‡ªå®šç¾©æ»¾å‹•æ¢æ¨£å¼ (Tooltip å…§éƒ¨) */
        .tooltip::-webkit-scrollbar {
            width: 6px;
        }

        .tooltip::-webkit-scrollbar-thumb {
            background: rgba(197, 160, 89, 0.5);
            border-radius: 10px;
        }

        .tooltip::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        /* Tooltip é—œé–‰æŒ‰éˆ•æ¨£å¼ */
        .tooltip-close-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 22px;
            height: 22px;
            background: rgba(255, 60, 60, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            line-height: 1;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            transition: all 0.2s;
            padding: 0;
        }

        .tooltip-close-btn:hover {
            background: rgba(255, 0, 0, 1);
            transform: scale(1.1);
        }

        /* ç•¶ tooltip è¢«å›ºå®šæ™‚é¡¯ç¤ºé—œé–‰æŒ‰éˆ• */
        .tooltip.tooltip-pinned {
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: auto !important;
        }

        .tooltip.tooltip-pinned .tooltip-close-btn {
            display: flex;
        }

        /* é˜²æ­¢ tooltip è¶…å‡ºå·¦é‚Šç•Œ - é‡å° grid ä½ˆå±€ */
        /* ä¸»è¦èƒ½åŠ›å€¼æ¦‚è¦½æ˜¯ 4 æ¬„ grid,æ‰€ä»¥æ¯è¡Œç¬¬ 1, 5, 9... å€‹å…ƒç´ éœ€è¦å·¦å°é½Š */
        .stat-mini-card:nth-child(4n+1) .tooltip {
            left: 0;
            transform: translateX(0);
        }

        /* é˜²æ­¢ tooltip è¶…å‡ºå³é‚Šç•Œ - é‡å° grid ä½ˆå±€ */
        /* ä¸»è¦èƒ½åŠ›å€¼æ¦‚è¦½æ˜¯ 4 æ¬„ grid,æ‰€ä»¥æ¯è¡Œç¬¬ 4, 8, 12... å€‹å…ƒç´ éœ€è¦å³å°é½Š */
        .stat-mini-card:nth-child(4n) .tooltip {
            left: auto;
            right: 0;
            transform: translateX(0);
        }

        /* ğŸ›¡ï¸ æŠ€èƒ½å¡ç‰‡é‚Šç•Œè™•ç† (é‡å°ç¶²é ç‰ˆä¸€æ’ 3 æ¬„) */
        /* æ¯æ’ç¬¬ 1 å€‹ (1, 4, 7...) - é å·¦ */
        .skill-card:nth-child(3n+1) .tooltip {
            left: 0;
            transform: translateX(0);
        }

        /* æ¯æ’ç¬¬ 2 å€‹ (2, 5, 8...) - ä¿æŒå±…ä¸­ (é è¨­) */
        .skill-card:nth-child(3n+2) .tooltip {
            left: 50%;
            transform: translateX(-50%);
        }

        /* æ¯æ’ç¬¬ 3 å€‹ (3, 6, 9...) - é å³ */
        .skill-card:nth-child(3n) .tooltip {
            left: auto;
            right: 0;
            transform: translateX(0);
        }

        /* ğŸ›¡ï¸ å°å¸³ç¸½è¡¨é‚Šç•Œè™•ç† - è®“å³å´æ¬„ä½çš„ tooltip é å³é¡¯ç¤º,é¿å…è¶…å‡ºé‚Šç•Œ */
        table td:nth-last-child(-n+4) .tooltip {
            left: auto;
            right: 0;
            transform: translateX(0);
        }

        /* è¡¨æ ¼ä¸­çš„ td éœ€è¦ç¢ºä¿ z-index èˆ‡æº¢å‡ºè¨­å®šæ­£ç¢º */
        table td {
            overflow: visible !important;
        }

        /* ç¢ºä¿ .hover-calc å®¹å™¨ä¹Ÿå…è¨±æº¢å‡º */
        .hover-calc {
            overflow: visible !important;
        }

        .th-hover,
        .hover-calc,
        .skill-card,
        .stat-mini-card {
            position: relative;
        }

        /* çµ±ä¸€çš„ hover æ•ˆæœ */
        .th-hover:hover .tooltip,
        .hover-calc:hover .tooltip,
        .skill-card:hover .tooltip,
        .stat-mini-card:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* ğŸ’¡ æ ¸å¿ƒä¿®æ­£ï¼šæ‡¸åœæ™‚æå‡å®¹å™¨å±¤ç´šï¼Œé˜²æ­¢ Tooltip è¢«å¾Œæ–¹å…ƒç´  (å¦‚è¡¨æ ¼çš„ä¸‹ä¸€è¡Œ) é®æ“‹ */
        .th-hover:hover,
        .hover-calc:hover,
        .skill-card:hover,
        .stat-mini-card:hover {
            z-index: 2000;
        }

        /* ç‚ºä¸‰å€‹å€å¡Šè¨­ç½®å®¹å™¨é™åˆ¶ */
        .stat-grid-main,
        .skill-list {
            position: relative;
            overflow: visible;
        }


        /* è¡¨æ ¼å®¹å™¨:çµ±ä¸€è¨­å®šæœ€å¤§é«˜åº¦èˆ‡è‡ªå‹•æ»¾å‹•,ä»¥å¯¦ç¾å›ºå®šè¡¨é ­ */
        .table-wrapper {
            position: relative;
            max-height: 70vh;
            /* è¨­å®šæœ€å¤§é«˜åº¦ä½¿è¡¨é ­èƒ½å›ºå®šåœ¨å®¹å™¨é ‚éƒ¨ */
            overflow: auto !important;
            /* åŒæ™‚æ”¯æ´æ°´å¹³èˆ‡å‚ç›´æ»¾å‹• */
            -webkit-overflow-scrolling: touch;
            margin-bottom: 80px;
            /* å¢åŠ åº•éƒ¨é–“è·,è®“ tooltip æœ‰ç©ºé–“é¡¯ç¤º */
            border: 1px solid var(--border);
            border-radius: 8px;
        }

        /* ç¶²é ç‰ˆè¡¨é ­å‡çµèª¿æ•´:é»åœ¨è¢å¹•é ‚éƒ¨,ä¸¦ç•™ä¸‹ä¸€é»é ‚éƒ¨é–“è· */
        thead th {
            position: sticky !important;
            top: 0 !important;
            z-index: 100;
            background: linear-gradient(145deg, #1a2332, #151b26);
            box-shadow: inset 0 -2px 0 var(--primary);
            vertical-align: middle !important;
        }

        /* è¡¨é ­çš„ tooltip ä½¿ç”¨ fixed å®šä½,ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        thead th.th-hover .tooltip {
            position: fixed !important;
            /* ä½¿ç”¨ fixed é¿å…è¢« sticky å…ƒç´ é®æ“‹ */
            bottom: auto;
            top: auto;
            /* ä½ç½®ç”± JavaScript å‹•æ…‹è¨ˆç®— */
            left: auto;
            transform: none;
            margin: 0;
            border-top: none;
            border-bottom: 3px solid var(--gold);
            z-index: 99999 !important;
            /* æ¥µé«˜çš„ z-index ç¢ºä¿åœ¨æœ€ä¸Šå±¤ */
        }

        /* ğŸ’¡ ä¿®æ­£ï¼šé‡å°ã€Œä¸»è¦èƒ½åŠ›å€¼æ¦‚è¦½ã€å€å¡Šï¼Œå°‡ Tooltip æ”¹ç‚ºå‘ä¸‹é¡¯ç¤º */
        .stat-mini-card .tooltip {
            max-width: min(300px, calc(100vw - 40px));
            /* æ”¹ç‚ºå‘ä¸‹é¡¯ç¤º */
            bottom: auto;
            top: 100%;
            margin-top: 10px;
            margin-bottom: 0;
            border-top: none;
            border-bottom: 3px solid var(--primary);
        }

        /* æŠ€èƒ½ç­‰ç´šåˆ†è§£ - tooltip æœ€å¤§å¯¬åº¦ */
        .skill-card .tooltip {
            max-width: min(250px, calc(100vw - 40px));
        }

        /* å±¬æ€§å…¨ä¾†æºå°å¸³ç¸½è¡¨ - tooltip æœ€å¤§å¯¬åº¦ */
        .hover-calc .tooltip {
            max-width: min(400px, calc(100vw - 40px));
            max-height: 500px;
        }

        /* ğŸ’¡ ä¿®æ­£ï¼šé‡å°è¡¨æ ¼å‰å…©è¡Œï¼Œå°‡ Tooltip æ”¹ç‚ºå‘ä¸‹é¡¯ç¤ºï¼Œé¿å…è¢«é ‚éƒ¨é‚Šç•Œæˆ–è¡¨é ­è£åˆ‡ */
        tbody tr:nth-child(-n+2) .hover-calc .tooltip {
            bottom: auto;
            top: 100%;
            margin-top: 10px;
            margin-bottom: 0;
            border-top: none;
            border-bottom: 3px solid var(--gold);
        }

        /* 4. è¡¨æ ¼åŸºç¤è¨­å®š */
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            min-width: 900px;
        }

        table td,
        table th {
            border-right: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            padding: 12px 10px;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle !important;
        }

        /* å‡çµé¦–æ¬„åŸºç¤æ¨£å¼ */
        .td-left {
            text-align: left !important;
            font-weight: bold;
            color: #fff;
            padding-left: 15px !important;
            position: sticky;
            left: 0;
            background: #1a1f29 !important;
            z-index: 90;
            min-width: 140px;
            box-shadow: 3px 0 6px rgba(0, 0, 0, 0.4);
        }

        /* è¡¨é ­æ¨£å¼ç§»è‡³ä¸Šæ–¹ table-wrapper å€å¡Šçµ±ä¸€ç®¡ç† */

        /* å·¦ä¸Šè§’äº¤å‰é»ï¼šéœ€åŒæ™‚å…·å‚™ top èˆ‡ left å‡çµ */
        thead th.td-left {
            z-index: 110;
            top: 0;
            left: 0;
        }

        .hover-calc {
            border-bottom: 1px dashed var(--primary);
            cursor: help;
            display: inline-block;
            vertical-align: middle;
        }

        .grid-box-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .info-box {
            background: linear-gradient(145deg, rgba(255, 217, 61, 0.08), rgba(255, 217, 61, 0.03));
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(5px);
        }

        .box-header {
            border-bottom: 2px solid var(--border);
            padding-bottom: 8px;
            margin-bottom: 10px;
            font-weight: 700;
            color: var(--gold-bright);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .title-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .title-box {
            background: linear-gradient(145deg, rgba(0, 212, 255, 0.12), rgba(0, 212, 255, 0.05));
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 12px;
            backdrop-filter: blur(5px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .title-box:hover {
            border-color: var(--blue-bright);
            box-shadow: 0 4px 15px var(--blue-glow);
            transform: translateY(-2px);
        }

        .title-label {
            font-size: 11px;
            color: var(--primary);
            display: block;
            border-bottom: 1px solid rgba(0, 212, 255, 0.3);
            margin-bottom: 5px;
            padding-bottom: 3px;
            font-weight: 600;
        }

        .title-val {
            font-size: 15px;
            font-weight: bold;
            color: var(--blue-bright);
            display: block;
            margin-bottom: 5px;
            text-shadow: 0 0 10px var(--blue-glow);
        }

        .title-desc {
            font-size: 12px;
            color: #aaa;
            line-height: 1.4;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 25px 0 15px 0;
            color: var(--gold-bright);
            font-size: 1.3em;
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            font-weight: 700;
            text-shadow: 0 0 15px var(--gold-glow);
        }

        #equip-armor-list,
        #equip-accessory-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
            gap: 12px;
        }

        .equip-item-card {
            background: linear-gradient(145deg, rgba(26, 35, 50, 0.4), rgba(15, 25, 34, 0.2));
            border: 2px solid var(--border);
            border-radius: 12px;
            display: flex;
            min-height: 120px;
            border-top: 3px solid var(--gold);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
        }

        .equip-item-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 217, 61, 0.1), transparent);
            transition: left 0.6s;
        }

        .equip-item-card:hover {
            background: linear-gradient(145deg, rgba(26, 35, 50, 0.6), rgba(15, 25, 34, 0.4));
            border-color: var(--gold);
            transform: translateY(-3px);
            box-shadow: 0 10px 30px var(--gold-glow),
                0 0 25px var(--gold-glow);
        }

        .equip-item-card:hover::before {
            left: 100%;
        }

        .equip-left-section {
            flex: 1.3;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }

        .equip-right-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            font-size: 12px;
        }

        .equip-img-container {
            position: relative;
            width: 44px;
            height: 44px;
            flex-shrink: 0;
        }

        .equip-img-container img {
            width: 44px;
            height: 44px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .exceed-badge {
            position: absolute;
            top: -7px;
            right: -7px;
            background: #ff3e3e;
            color: white;
            border: 1px solid #ffd700;
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 4px;
            font-weight: bold;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .equip-name {
            font-weight: bold;
            font-size: 14px;
            line-height: 1.4;
            display: flex;
            align-items: center;
            color: var(--blue-bright);
        }

        .base-stat-row {
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 4px 0;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .random-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--green);
            margin-bottom: 3px;
        }

        .skill-badge-mini {
            color: var(--primary);
            margin-top: 5px;
            display: block;
            font-weight: bold;
            border-left: 3px solid var(--primary);
            padding-left: 8px;
            font-size: 11px;
            text-shadow: 0 0 10px var(--blue-glow);
        }

        /* RWD èª¿æ•´ */
        @media (min-width: 1400px) {
            .main-layout-wrapper {
                display: grid;
                grid-template-columns: 4fr 6fr;
                gap: 20px;
            }
        }

        @media (max-width: 768px) {
            .profile-card {
                flex-direction: column;
                text-align: center;
            }

            .api-input-group {
                flex-direction: column;
                align-items: stretch;
            }

            .api-input-group input,
            .api-input-group select,
            .btn-api {
                min-width: unset;
            }

            .stat-grid-main {
                grid-template-columns: repeat(2, 1fr);
            }

            /* æ‰‹æ©Ÿç‰ˆï¼šé‡å°èƒ½åŠ›å€¼å¡ç‰‡ (2 æ¬„) */
            /* å·¦å´å¡ç‰‡ (1, 3, 5...) */
            .stat-mini-card:nth-child(odd) .tooltip {
                left: 0 !important;
                right: auto !important;
                transform: translateX(0) !important;
            }

            /* å³å´å¡ç‰‡ (2, 4, 6...) */
            .stat-mini-card:nth-child(even) .tooltip {
                left: auto !important;
                right: 0 !important;
                transform: translateX(0) !important;
            }

            /* æ‰‹æ©Ÿç‰ˆï¼šé‡å°æŠ€èƒ½å¡ç‰‡ (ä¸€æ’ 2 æ¬„) */
            .skill-list {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            /* ğŸ›¡ï¸ æ‰‹æ©Ÿç‰ˆæŠ€èƒ½å¡ç‰‡ Tooltip é‚Šç•Œè™•ç† (é‡å°ä¸€æ’ 2 æ¬„) */
            /* æ¯æ’ç¬¬ 1 å€‹ (1, 3, 5...) - é å·¦å°é½Š */
            .skill-card:nth-child(2n+1) .tooltip {
                left: 0 !important;
                right: auto !important;
                transform: translateX(0) !important;
                width: 80vw !important;
                max-width: 250px !important;
            }

            /* æ¯æ’ç¬¬ 2 å€‹ (2, 4, 6...) - é å³å°é½Š (right: 0) */
            .skill-card:nth-child(2n) .tooltip {
                left: auto !important;
                right: 0 !important;
                transform: translateX(0) !important;
                width: 80vw !important;
                max-width: 250px !important;
            }

            #equip-armor-list,
            #equip-accessory-list {
                grid-template-columns: 1fr;
            }

            .grid-box-container {
                grid-template-columns: 1fr;
            }

            .title-grid {
                grid-template-columns: 1fr;
            }

            .rank-badge {
                width: 100%
            }

        }



        /* æ‰‹æ©Ÿç‰ˆï¼šé‡å°è¡¨æ ¼è¨­ç½®å›ºå®šé«˜åº¦èˆ‡å…§éƒ¨æ²å‹• */
        @media (max-width: 768px) {
            .table-wrapper {
                max-height: 500px;
                /* æ‰‹æ©Ÿç‰ˆé€šå¸¸è¢å¹•è¼ƒå°ï¼Œç¸®æ¸›æœ€å¤§é«˜åº¦ */
                overflow: auto !important;
            }

            /* æ‰‹æ©Ÿç‰ˆï¼šè¡¨é ­éœ€é»åœ¨å®¹å™¨é ‚éƒ¨ */
            thead th {
                top: 0 !important;
            }
        }

        /* è¡¨æ ¼è…³æ­¥è¼”åŠ©æ¨£å¼å·²æ•´åˆè‡³ä¸Šæ–¹ */

        /* 7. è¡Œå…§æ‡¸åœæ•ˆæœ (Hover) */
        /* å¢åŠ é€™æ®µèƒ½è®“ä½¿ç”¨è€…åœ¨çœ‹é•·è¡¨æ ¼æ™‚,ä¸å®¹æ˜“çœ‹éŒ¯è¡Œ */
        tbody tr {
            position: relative;
        }

        tbody tr:hover td {
            background-color: rgba(255, 255, 255, 0.05);
        }

        tbody td {
            position: relative;
            /* ç¢ºä¿ tooltip èƒ½å¤ åŸºæ–¼ td å®šä½ */
        }

        /* 8. æ²å‹•æ¢ç¾åŒ– */
        .table-wrapper::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .table-wrapper::-webkit-scrollbar-thumb {
            background: var(--gold, #c5a059);
            border-radius: 10px;
        }

        .table-wrapper::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        /* 11. æ‘ºç–Šé¢æ¿ç›¸é—œæ¨£å¼ */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin-top: 25px;
            border-left: 5px solid var(--gold);
            transition: all 0.2s;
        }

        .collapsible-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .collapsible-header h3 {
            margin: 0;
            border-left: none;
            padding-left: 0;
            font-size: 17px;
        }

        .collapsible-content {
            overflow: hidden;
            max-height: 2500px;
            transition: max-height 0.5s cubic-bezier(0, 1, 0, 1), opacity 0.3s, margin 0.3s;
            opacity: 1;
            margin-top: 15px;
        }

        .collapsible-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-top: 0;
        }

        .toggle-icon {
            color: var(--gold);
            transition: transform 0.3s;
            font-size: 12px;
        }

        .collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
    </style>

</head>

<body>
    <div id="loading" class="loading-overlay">âŒ› æ­£åœ¨å¾ä¼ºæœå™¨ç²å–æ•¸æ“šï¼Œè«‹ç¨å€™...</div>

    <div class="container">
        <div class="input-area">
            <h2 style="color:var(--gold); margin-top:0; text-align: center;">ğŸ’ Aion2 è§’è‰²æ•¸æ“šæŸ¥è©¢ç³»çµ±</h2>

            <div class="import-section">
                <div style="font-size: 14px; color: var(--gold); font-weight: bold;">ğŸ” æ–¹æ³• Aï¼šå¿«é€Ÿè§’è‰²æŸ¥è©¢</div>
                <div class="api-input-group">
                    <input type="text" id="charNameInput" placeholder="è¼¸å…¥è§’è‰²åç¨± (ä¾‹å¦‚: æˆ‘æ„›å°ç´…ç·š)...">

                    <select id="serverSelect">
                        <optgroup label="â”€â”€â”€ å¤©æ—ä¼ºæœå™¨ â”€â”€â”€">
                            <option value="å°¤æ–¯è¿ªåŸƒ">å°¤æ–¯è¿ªåŸƒ</option>
                            <option value="å¸ŒåŸƒçˆ¾">å¸ŒåŸƒçˆ¾</option>
                            <option value="å¥ˆè–©è‚¯">å¥ˆè–©è‚¯</option>
                            <option value="ç™½å‚‘çˆ¾">ç™½å‚‘çˆ¾</option>
                            <option value="å‡±è¥¿å…§çˆ¾">å‡±è¥¿å…§çˆ¾</option>
                            <option value="è‰¾ç‘çˆ¾">è‰¾ç‘çˆ¾</option>
                            <option value="æ™®é›·å¥‡ç¿">æ™®é›·å¥‡ç¿</option>
                            <option value="æ¢…æ–¯è˜­æ³°é”">æ¢…æ–¯è˜­æ³°é”</option>
                            <option value="å¸Œå¡”å°¼è€¶">å¸Œå¡”å°¼è€¶</option>
                            <option value="ç´å°¼äº">ç´å°¼äº</option>
                            <option value="å¡”å“ˆå·´é”">å¡”å“ˆå·´é”</option>
                            <option value="è·¯ç‰¹æ–¯">è·¯ç‰¹æ–¯</option>
                            <option value="è²çˆ¾è«¾æ–¯">è²çˆ¾è«¾æ–¯</option>
                            <option value="é”å½ŒåŠª">é”å½ŒåŠª</option>
                            <option value="å¡è–©å¡">å¡è–©å¡</option>
                            <option value="å·´å¡çˆ¾æ‘©">å·´å¡çˆ¾æ‘©</option>
                            <option value="å¤©åŠ éš†">å¤©åŠ éš†</option>
                            <option value="ç§‘å¥‡éš†">ç§‘å¥‡éš†</option>
                        </optgroup>
                        <optgroup label="â”€â”€â”€ é­”æ—ä¼ºæœå™¨ â”€â”€â”€">
                            <option value="ä¼Šæ–¯æ‹‰ä½©çˆ¾">ä¼Šæ–¯æ‹‰ä½©çˆ¾</option>
                            <option value="å‰å‡±çˆ¾">å‰å‡±çˆ¾</option>
                            <option value="å´”å¦®çˆ¾">å´”å¦®çˆ¾</option>
                            <option value="éœ²æ¢…çˆ¾">éœ²æ¢…çˆ¾</option>
                            <option value="ç‘ªçˆ¾åº«å¦">ç‘ªçˆ¾åº«å¦</option>
                            <option value="é˜¿æ–¯ä½©çˆ¾">é˜¿æ–¯ä½©çˆ¾</option>
                            <option value="è‰¾èŠä¿®å¥‡å¡">è‰¾èŠä¿®å¥‡å¡</option>
                            <option value="å¸ƒé‡Œç‰¹æ‹‰">å¸ƒé‡Œç‰¹æ‹‰</option>
                            <option value="å¥ˆè’™">å¥ˆè’™</option>
                            <option value="å“ˆé”çˆ¾">å“ˆé”çˆ¾</option>
                            <option value="ç›§å¾·èŠ">ç›§å¾·èŠ</option>
                            <option value="é„”çˆ¾å¤å€«">é„”çˆ¾å¤å€«</option>
                            <option value="é»˜å°¼">é»˜å°¼</option>
                            <option value="å¥§é”çˆ¾">å¥§é”çˆ¾</option>
                            <option value="ç°¡å¡å¡">ç°¡å¡å¡</option>
                            <option value="å…‹ç¾…æ¢…å¾·">å…‹ç¾…æ¢…å¾·</option>
                            <option value="å¥éˆ">å¥éˆ</option>
                            <option value="å·´å·´éš†">å·´å·´éš†</option>
                        </optgroup>
                    </select>



                    <button class="btn-api" onclick="fetchFromApi()">ç«‹å³æŸ¥è©¢</button>
                </div>


                èˆˆè¶£è£½ä½œéå•†æ¥­ç”¨é€”ï¼Œè«‹å‹¿ç”¨æ–¼ç‡Ÿåˆ©è¡Œç‚ºï¼Œè³‡æ–™æœ‰èª¤ä¾å®˜æ–¹ç‚ºä¸»ã€‚
            </div>
        </div>

        <div id="main-content" class="dashboard">
            <div class="profile-card">
                <img id="p-img" class="profile-img" src="">
                <div style="flex:1">
                    <span id="p-name" class="profile-name"></span>
                    <span id="p-title-disp" style="color:var(--blue); margin-left:15px; font-weight:bold;"></span>
                    <div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:10px; color:#8b949e">
                        <span>ä¼ºæœå™¨ï¼š<b id="p-server" style="color:var(--gold)"></b></span>
                        <span>ç­‰ç´šï¼š<b id="p-lv" style="color:var(--gold)"></b></span>
                        <span>è·æ¥­ï¼š<b id="p-class" style="color:var(--gold)"></b></span>
                        <span>é“å…·ç­‰ç´šï¼š<b id="p-itemlv" style="color:#58a6ff"></b></span>
                        <span>å®˜æ–¹æ•¸æ“šæ›´æ–°æ™‚é–“ï¼š<b id="p-update" style="color:#3fb950"></b></span>
                    </div>
                    <div id="p-ranking-container" class="rank-container"></div>
                </div>
            </div>

            <div class="main-layout-wrapper">
                <div class="left-column">
                    <div class="card">
                        <h3>ğŸ“Š ä¸»è¦èƒ½åŠ›å€¼æ¦‚è¦½</h3>
                        <h5>(æ­¤å€å®˜æ–¹æ²’æœ‰å³æ™‚æ›´æ–°)</h5>
                        <div id="stat-main-grid" class="stat-grid-main"></div>
                    </div>
                    <div class="card">
                        <h3>âš”ï¸ æŠ€èƒ½ç­‰ç´šåˆ†è§£</h3>
                        <div class="sk-label">â–¶ ä¸»å‹•æŠ€èƒ½</div>
                        <div id="sk-act" class="skill-list"></div>
                        <div class="sk-label">â–¶ è¢«å‹•æŠ€èƒ½</div>
                        <div id="sk-pas" class="skill-list"></div>
                        <div class="sk-label">â–¶ ç‰¹æ®Š/çƒ™å°æŠ€èƒ½</div>
                        <div id="sk-stigma" class="skill-list"></div>
                    </div>
                    <div class="card">
                        <h3>ğŸ´ é­”åŠ›è–ç‰©ç³»çµ±ç´°é …</h3>
                        <div id="arcana-grid" class="grid-box-container"></div>
                        <h3>ğŸ”± å¥—è£æ•ˆæœå…¨è¦½</h3>
                        <div id="set-bonus-grid" class="grid-box-container" style="grid-template-columns: 1fr;"></div>
                    </div>
                </div>
                <div class="right-column">
                    <!-- æˆ°é¬¥æ•¸æ“šåˆ†æå€å¡Š -->
                    <div class="card">
                        <h3>âš”ï¸ åŸºç¤æ•¸æ“šåˆ†æ</h3>
                        <div id="combat-stats-grid" class="grid-box-container"
                            style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;"></div>
                    </div>
                    <div class="card" style="padding:0">
                        <h3 style="padding: 25px 25px 0 25px;">ğŸ›¡ï¸ å±¬æ€§å…¨ä¾†æºå°å¸³ç¸½è¡¨</h3>
                        <div class="table-wrapper" style="margin-bottom: 20px;">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="td-left">å±¬æ€§é …ç›®</th>
                                        <th class="th-hover" style="color:var(--nezakan)" data-board="å¥ˆè–©è‚¯">å¥ˆè–©è‚¯<div
                                                class="tooltip" id="tooltip-nezakan"></div>
                                        </th>
                                        <th class="th-hover" style="color:var(--zikel)" data-board="å‰å‡±çˆ¾">å‰å‡±çˆ¾<div
                                                class="tooltip" id="tooltip-zikel"></div>
                                        </th>
                                        <th class="th-hover" style="color:var(--baizel)" data-board="ç™½å‚‘çˆ¾">ç™½å‚‘çˆ¾<div
                                                class="tooltip" id="tooltip-baizel"></div>
                                        </th>
                                        <th class="th-hover" style="color:var(--triniel)" data-board="å´”å¦®çˆ¾">å´”å¦®çˆ¾<div
                                                class="tooltip" id="tooltip-triniel"></div>
                                        </th>
                                        <th class="th-hover" style="color:var(--ariel)" data-board="è‰¾ç‘çˆ¾">è‰¾ç‘çˆ¾<div
                                                class="tooltip" id="tooltip-ariel"></div>
                                        </th>
                                        <th class="th-hover" style="color:var(--asphel)" data-board="é˜¿æ–¯ä½©çˆ¾">é˜¿æ–¯ä½©çˆ¾<div
                                                class="tooltip" id="tooltip-asphel"></div>
                                        </th>
                                        <th style="color:var(--gold)">æ­¦é˜²å¼·åŒ–</th>
                                        <th style="color:var(--blue)">åˆ»å°/ç£¨çŸ³</th>
                                        <th>è–ç‰©/ç¨±è™Ÿ</th>
                                        <th style="color:var(--green)">æœ€çµ‚åŠ ç¸½</th>
                                    </tr>
                                </thead>
                                <tbody id="stat-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card">
                        <h3>ğŸ–ï¸ ç¨±è™Ÿç³»çµ±åŠ æˆç´°é …</h3>
                        <div id="title-grid" class="title-grid"></div>
                        <h3 style="margin-top: 25px;">ğŸ¾ å¯µç‰©èˆ‡ç¿…è†€</h3>
                        <div id="petwing-grid" class="grid-box-container"></div>

                        <!-- ç¿…è†€æ”¶è—ç³»çµ±æ‘ºç–Šå€å¡Š -->
                        <div id="wing-collection-header" class="collapsible-header" onclick="toggleWingCollection()">
                            <h3>ğŸª½ ç¿…è†€æ”¶è—ç³»çµ±</h3>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 12px; color: #8b949e;">(é»æ“Šå±•é–‹/æ”¶åˆ)</span>
                                <span id="wing-toggle-icon" class="toggle-icon">â–¼</span>
                            </div>
                        </div>
                        <div id="wing-collection-wrapper" class="collapsible-content">
                            <div style="font-size:12px; color:#8b949e; margin-bottom:15px; padding-left: 5px;">
                                ğŸ’¡ å‹¾é¸æ‚¨æŒæœ‰çš„ç¿…è†€ï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—ã€ŒæŒæœ‰æ•ˆæœã€ä¸¦åŠ å…¥å°å¸³ç¸½è¡¨
                            </div>
                            <div id="wing-collection-grid"
                                style="display:grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap:10px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="section-header">ğŸ›¡ï¸ æ­¦å™¨èˆ‡é˜²å…·</div>
                <div id="equip-armor-list"></div>
                <div class="section-header">ğŸ’ é£¾å“èˆ‡é…ä»¶</div>
                <div id="equip-accessory-list"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–ï¼šè®€å–ä¸Šæ¬¡æœå°‹çš„è§’è‰²èˆ‡ä¼ºæœå™¨
        window.onload = function () {
            const savedName = localStorage.getItem('last_char_name');
            const savedServer = localStorage.getItem('last_server');
            if (savedName) document.getElementById('charNameInput').value = savedName;
            if (savedServer) document.getElementById('serverSelect').value = savedServer;
        }

        // Proxy å‡½æ•¸
        function getProxyUrl(url) {
            return `https://proxy.kk69347321.workers.dev/?url=${encodeURIComponent(url)}`;
        }

        // ç¿…è†€æ‰‹å·¥ç¶­è­·è³‡æ–™åº« (æ ¹æ“šä½¿ç”¨è€…æä¾›è³‡æ–™è¡¨)
        const WING_DATABASE = {
            'é»‘æš—å¸³å¹•ç¿…è†€': {
                equip: { 'é¡å¤–æ”»æ“ŠåŠ›': 60, 'å‚·å®³å¢å¹…': 0.025, 'é¦–é ˜é˜²ç¦¦åŠ›': 500, 'é¦–é ˜å‚·å®³è€æ€§': 0.035 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'å‚·å®³å¢å¹…': 0.01, 'é¦–é ˜é˜²ç¦¦åŠ›': 300 }
            },
            'ç‡¦çˆ›çš„æ„›ä¹‹ç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 400, 'é¡å¤–è¿´é¿': 35, 'ç²¾ç¥åŠ›è‡ªç„¶æ¢å¾©': 90, 'ç”Ÿå‘½åŠ›è—¥æ°´æ¢å¾©å¢åŠ ': 0.055 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–é˜²ç¦¦åŠ›': 100, 'ç²¾ç¥åŠ›': 100 }
            },
            'å®ˆè­·è€…ä¸‹ç´šç¿…è†€': {
                equip: { 'ç”Ÿå‘½åŠ›': 200 },
                hold: { 'é£›è¡ŒåŠ›': 2000, 'ç”Ÿå‘½åŠ›': 50 }
            },
            'å®ˆè­·è€…ä¸­ç´šç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 200, 'ç”Ÿå‘½åŠ›': 300 },
                hold: { 'é£›è¡ŒåŠ›': 500, 'é¡å¤–æ”»æ“ŠåŠ›': 10 }
            },
            'å®ˆè­·è€…ä¸Šç´šç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 300, 'ç²¾ç¥åŠ›': 200, 'ç”Ÿå‘½åŠ›': 400 },
                hold: { 'é£›è¡ŒåŠ›': 500, 'é¡å¤–é˜²ç¦¦åŠ›': 100 }
            },
            'å®ˆè­·è€…æœ€ä¸Šç´šç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 400, 'ç”Ÿå‘½åŠ›': 500, 'ç²¾ç¥åŠ›': 250, 'è²«ç©¿': 500 },
                hold: { 'é£›è¡ŒåŠ›': 500, 'é¡å¤–å‘½ä¸­': 20, 'è²«ç©¿': 100 }
            },
            'é˜¿çˆ¾æ‹‰çƒç¿…è†€': {
                equip: { 'é¡å¤–è¿´é¿': 25, 'ç”Ÿå‘½åŠ›': 300 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'ç”Ÿå‘½åŠ›': 50 }
            },
            'å¾æœè€…ç¿…è†€': {
                equip: { 'é¦–é ˜æ”»æ“ŠåŠ›': 80, 'é¦–é ˜é˜²ç¦¦åŠ›': 400, 'é¡å¤–é˜²ç¦¦åŠ›': 300, },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¦–é ˜æ”»æ“ŠåŠ›': 10, }
            },
            'å°å°ç¿…è†€': {
                equip: { 'ç”Ÿå‘½åŠ›': 400, 'ç”Ÿå‘½åŠ›è‡ªç„¶æ¢å¾©': 200, 'æ‰€å—æ²»ç™’é‡': 0.05, },
                hold: { 'é£›è¡ŒåŠ›': 200, 'ç”Ÿå‘½åŠ›': 50, }
            },
            'å…‰æ¦®ç¿…è†€': {
                equip: { 'ç²¾ç¥åŠ›æ¶ˆè€—é‡æ¸›å°‘': 0.03, 'ç²¾ç¥åŠ›': 200, 'ç²¾ç¥åŠ›è‡ªç„¶æ¢å¾©': 80, },
                hold: { 'é£›è¡ŒåŠ›': 200, 'ç²¾ç¥åŠ›æ¶ˆè€—é‡æ¸›å°‘': 0.01, }
            },
            'å…‹ç¾…æ¢…å¾·ç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 200, 'æš´æ“Š': 35, 'ç”Ÿå‘½åŠ›': 500, 'ç”Ÿå‘½åŠ›è‡ªç„¶æ¢å¾©': 250, },
                hold: { 'é£›è¡ŒåŠ›': 200, 'ç”Ÿå‘½åŠ›': 50, 'ç”Ÿå‘½åŠ›è‡ªç„¶æ¢å¾©': 50, }

            },
            'ç´«èŠ±è´è¶ç¿…è†€': {
                equip: { 'é¡å¤–æ”»æ“ŠåŠ›': 40, 'é¡å¤–é˜²ç¦¦åŠ›': 200, },
                hold: { 'é£›è¡ŒåŠ›': 200, 'ç”Ÿå‘½åŠ›': 50 }
            },
            'å¦–ç²¾ä¹‹å¤¢ç¿…è†€': {
                equip: { 'ç”Ÿå‘½åŠ›è‡ªç„¶æ¢å¾©': 0.05, 'ç”Ÿå‘½åŠ›è—¥æ°´æ¢å¾©': 300, },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–æ”»æ“ŠåŠ›': 10, }
            },
            'å‹‡å£«ç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 300, 'ç²¾ç¥åŠ›': 200, 'è¡æ“Šç³»æ“Šä¸­': 0.04, },
                hold: { 'é£›è¡ŒåŠ›': 200, 'è¡æ“Šç³»æŠµæŠ—': 0.025 }
            },
            'å¥§å¾·ç¿…è†€': {
                equip: { 'ç”Ÿå‘½åŠ›': 400, 'ç²¾ç¥åŠ›è‡ªç„¶æ¢å¾©': 80, 'ç²¾ç¥åŠ›': 200 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–é˜²ç¦¦åŠ›': 100 }
            },
            'ç²¾éˆç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 300, 'ç”Ÿå‘½åŠ›': 400, 'æ ¼æ“‹': 50, },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–é˜²ç¦¦åŠ›': 100 }
            },
            'å¤ä»£é˜¿çˆ¾æ‹‰å±‹ç¿…è†€': {
                equip: { 'é¡å¤–æ”»æ“ŠåŠ›': 60, 'é¡å¤–é˜²ç¦¦åŠ›': 400, 'ç”Ÿå‘½åŠ›': 500, 'ç”Ÿå‘½åŠ›è‡ªç„¶æ¢å¾©': 250 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–å‘½ä¸­': 20, 'å¾Œæ–¹æ”»æ“ŠåŠ›': 10 }
            },
            'é—‡é»‘ç¢ç‰‡ç¿…è†€': {
                equip: { 'æš´æ“Š': 35, 'æš´æ“Šæ”»æ“ŠåŠ›': 95, 'ç”Ÿå‘½åŠ›': 500, 'ç”Ÿå‘½åŠ›è‡ªç„¶æ¢å¾©': 250 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–è¿´é¿': 20, 'æ ¼æ“‹': 10 }
            },
            'è—è‰²æ³¢æ¿¤ç¿…è†€': {
                equip: { 'é¡å¤–è¿´é¿': 35, 'æš´æ“ŠæŠµæŠ—': 35, 'ç²¾ç¥åŠ›': 250, 'ç²¾ç¥åŠ›è‡ªç„¶æ¢å¾©': 90 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'æš´æ“ŠæŠµæŠ—': 20, 'å¾Œæ–¹æš´æ“ŠæŠµæŠ—': 40 }
            },
            'æ£®æ—ç²¾éˆç¿…è†€': {
                equip: { 'é¦–é ˜æ”»æ“ŠåŠ›': 95, 'é¦–é ˜å‚·å®³å¢å¹…': 0.035, 'å‚·å®³è€æ€§': 0.025, 'é¡å¤–é˜²ç¦¦åŠ›': 400 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'å‚·å®³è€æ€§': 0.01, 'é¦–é ˜æ”»æ“ŠåŠ›': 30 },
            },
            'æƒ¡å¤¢ç¿…è†€': {
                equip: { 'é¡å¤–æ”»æ“ŠåŠ›': 60, 'å‚·å®³å¢å¹…': 0.035, 'æš´æ“Š': 35, 'é¦–é ˜å‚·å®³å¢å¹…': 0.035 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¦–é ˜æ”»æ“ŠåŠ›': 30, 'é¦–é ˜é˜²ç¦¦åŠ›': 250 }
            },
            'é¬¥å£«ç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 400, 'ç”Ÿå‘½åŠ›': 500, 'è¡æ“Šç³»æ“Šä¸­': 0.03, 'ç•°å¸¸ç‹€æ…‹æ“Šä¸­': 0.03 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'å‚·å®³è€æ€§': 0.01, 'è¡æ“Šç³»æ“Šä¸­': 0.025 }
            },
            'è—è´è¶ç¿…è†€': {
                equip: { 'é¡å¤–é˜²ç¦¦åŠ›': 400, 'ç”Ÿå‘½åŠ›è—¥æ°´æ¢å¾©': 300, 'ç”Ÿå‘½åŠ›è—¥æ°´æ¢å¾©å¢åŠ ': 0.05, 'ç”Ÿå‘½åŠ›': 500 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–å‘½ä¸­': 20, 'é¡å¤–è¿´é¿': 20 }
            },
            'æ˜¥èŠ±è´è¶ç¿…è†€': {
                equip: { 'é¡å¤–æ”»æ“ŠåŠ›': 60, 'é¡å¤–å‘½ä¸­': 35, 'æ ¼æ“‹è²«ç©¿': 60, 'è²«ç©¿': 500 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–æ”»æ“ŠåŠ›': 10, 'æ ¼æ“‹è²«ç©¿': 10 }
            },
            'ç©ºè™›å¡”é‡Œæ–¯æ‹‰ç¿…è†€': {
                equip: { 'é¡å¤–æ”»æ“ŠåŠ›': 60, 'é¡å¤–é˜²ç¦¦åŠ›': 400, 'é¡å¤–å‘½ä¸­': 35, 'å†·å»æ™‚é–“æ¸›å°‘': 0.04 },
                hold: { 'é£›è¡ŒåŠ›': 200, 'é¡å¤–å‘½ä¸­': 20, 'é¡å¤–é˜²ç¦¦åŠ›': 100 }
            }
        };

        // Helper function to fetch all titles with pagination
        async function fetchAllTitles(serverId, characterId, initialTitleList, ownedCount) {
            let allTitles = [...initialTitleList]; // Start with the titles already fetched
            let currentPage = 1; // Assuming initialTitleList is from page 1

            // If ownedCount is not available or initial list is already complete, no need to paginate
            if (!ownedCount || allTitles.length >= ownedCount) {
                return allTitles;
            }

            // Loop until all titles are fetched or an error occurs
            while (allTitles.length < ownedCount) {
                currentPage++;
                const titlesUrl = `https://aion-api.bnshive.com/v1/characters/${serverId}/${encodeURIComponent(characterId)}/titles?page=${currentPage}`;
                const titlesProxyUrl = getProxyUrl(titlesUrl);

                console.log(`Fetching titles page ${currentPage} from:`, titlesProxyUrl);

                try {
                    const response = await fetch(titlesProxyUrl);
                    if (!response.ok) {
                        console.error(`Failed to fetch titles page ${currentPage}: ${response.status}`);
                        break; // Stop if a page fails
                    }
                    const json = await response.json();

                    // Assuming the API returns a structure like { result: "Success", data: { titleList: [...] } }
                    const newTitles = json.data && json.data.titleList ? json.data.titleList : [];

                    if (newTitles.length === 0) {
                        // No more titles to fetch, or an issue with the API response
                        console.log(`No new titles found on page ${currentPage}. Stopping pagination.`);
                        break;
                    }

                    allTitles = allTitles.concat(newTitles);
                    console.log(`Fetched ${newTitles.length} titles on page ${currentPage}. Total titles: ${allTitles.length}/${ownedCount}`);

                } catch (error) {
                    console.error(`Error fetching titles page ${currentPage}:`, error);
                    break; // Stop on error
                }
            }
            return allTitles;
        }

        // --- æ ¸å¿ƒ API è«‹æ±‚é‚è¼¯ ---
        async function fetchFromApi() {
            const charName = document.getElementById('charNameInput').value.trim();
            const serverName = document.getElementById('serverSelect').value;

            if (!charName) {
                alert("è«‹è¼¸å…¥è§’è‰²åç¨±");
                return;
            }

            // å„²å­˜è¨­å®š
            localStorage.setItem('last_char_name', charName);
            localStorage.setItem('last_server', serverName);

            document.getElementById('loading').style.display = 'flex';

            try {
                // === æ­¥é©Ÿ 1: å…ˆæŸ¥è©¢ä¸€æ¬¡è§’è‰²è³‡æ–™,ç²å– characterId ===
                console.log('æ­¥é©Ÿ 1: æŸ¥è©¢è§’è‰²ä»¥ç²å– characterId...');
                const queryUrl = `https://aion-api.bnshive.com/character/query?name=${encodeURIComponent(charName)}&server=${encodeURIComponent(serverName)}`;
                const queryProxyUrl = getProxyUrl(queryUrl);

                console.log('æŸ¥è©¢ URL:', queryUrl);

                const firstResponse = await fetch(queryProxyUrl);
                console.log('åˆæ¬¡æŸ¥è©¢ç‹€æ…‹:', firstResponse.status);

                if (!firstResponse.ok) {
                    const errorText = await firstResponse.text();
                    throw new Error(`æŸ¥è©¢å¤±æ•—: ${firstResponse.status}\n${errorText.substring(0, 200)}`);
                }

                const firstJson = await firstResponse.json();
                console.log('åˆæ¬¡æŸ¥è©¢çµæœ:', firstJson);

                // æª¢æŸ¥çµæœ
                if (!firstJson || (firstJson.result === "Fail")) {
                    throw new Error(firstJson.message || "æ‰¾ä¸åˆ°è©²è§’è‰²,è«‹ç¢ºèªåç¨±èˆ‡ä¼ºæœå™¨æ˜¯å¦æ­£ç¢ºã€‚");
                }

                // å¾æŸ¥è©¢çµæœä¸­æå– characterId å’Œ serverId
                let characterId = null;
                let serverId = null;

                // å˜—è©¦å¾ä¸åŒçš„è³‡æ–™çµæ§‹ä¸­æå–
                const data = firstJson.queryResult ? firstJson.queryResult.data : (firstJson.data ? firstJson.data : firstJson);

                if (data && data.profile) {
                    characterId = data.profile.characterId;
                    serverId = data.profile.serverId;
                }

                if (!characterId || !serverId) {
                    console.warn('âš  ç„¡æ³•ç²å– characterId,è·³éæ›´æ–°æ­¥é©Ÿ');
                    // å¦‚æœç„¡æ³•ç²å– characterId,ç›´æ¥é¡¯ç¤ºç¬¬ä¸€æ¬¡æŸ¥è©¢çš„çµæœ
                    processData(firstJson);
                    // document.getElementById('jsonInput').value = `è§’è‰² [${charName}] æ•¸æ“šè®€å–æˆåŠŸ!`;
                    return;
                }

                console.log('âœ“ æ‰¾åˆ°è§’è‰² ID:', characterId, 'ä¼ºæœå™¨ ID:', serverId);

                // === æ­¥é©Ÿ 2: ä½¿ç”¨ refresh=true è§¸ç™¼æ›´æ–°ä¸¦ç²å–æœ€æ–°è³‡æ–™ ===
                console.log('æ­¥é©Ÿ 2: è§¸ç™¼æ›´æ–°ä¸¦æŸ¥è©¢æœ€æ–°è³‡æ–™...');
                const refreshUrl = `https://aion-api.bnshive.com/character/query?serverId=${serverId}&characterId=${encodeURIComponent(characterId)}&refresh=true`;
                const refreshProxyUrl = getProxyUrl(refreshUrl);

                console.log('æ›´æ–°æŸ¥è©¢ URL:', refreshUrl);
                console.log('â³ æ­£åœ¨å¾å®˜æ–¹ API ç²å–æœ€æ–°è³‡æ–™,è«‹ç¨å€™...');

                const refreshResponse = await fetch(refreshProxyUrl);
                console.log('æ›´æ–°æŸ¥è©¢ç‹€æ…‹:', refreshResponse.status);

                let finalJson = firstJson; // é è¨­ä½¿ç”¨åˆæ¬¡æŸ¥è©¢çš„è³‡æ–™

                if (refreshResponse.ok) {
                    const refreshJson = await refreshResponse.json();
                    console.log('âœ“ æ›´æ–°æŸ¥è©¢çµæœ:', refreshJson);

                    if (refreshJson && refreshJson.result !== "Fail") {
                        finalJson = refreshJson;
                        console.log('âœ“ å·²ç²å–æœ€æ–°è³‡æ–™!');
                    } else {
                        console.warn('âš  æ›´æ–°æŸ¥è©¢è¿”å›å¤±æ•—,ä½¿ç”¨åˆæ¬¡æŸ¥è©¢çš„è³‡æ–™');
                    }
                } else {
                    console.warn('âš  æ›´æ–°æŸ¥è©¢å¤±æ•—,ä½¿ç”¨åˆæ¬¡æŸ¥è©¢çš„è³‡æ–™');
                }

                // === æ­¥é©Ÿ 3: è¨˜éŒ„è¨ªå• (å¯é¸,ä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½) ===
                try {
                    console.log('æ­¥é©Ÿ 3: è¨˜éŒ„è¨ªå•...');
                    const visitUrl = `https://aion-api.bnshive.com/character/${serverId}/${encodeURIComponent(characterId)}/visit`;
                    const visitProxyUrl = getProxyUrl(visitUrl);

                    await fetch(visitProxyUrl, { method: 'POST' });
                    console.log('âœ“ è¨ªå•å·²è¨˜éŒ„');
                } catch (visitError) {
                    console.log('è¨ªå•è¨˜éŒ„å¤±æ•—(ä¸å½±éŸ¿ä¸»è¦åŠŸèƒ½):', visitError.message);
                }

                // é¡¯ç¤ºè³‡æ–™
                processData(finalJson);
                // document.getElementById('jsonInput').value = `è§’è‰² [${charName}] æ•¸æ“šè®€å–æˆåŠŸ! (å·²å¾å®˜æ–¹ API æ›´æ–°)`;
                console.log('âœ“ å®Œæˆ!å·²é¡¯ç¤ºæœ€æ–°è³‡æ–™');

            } catch (err) {
                console.error('âŒ å®Œæ•´éŒ¯èª¤:', err);
                alert("è®€å–å¤±æ•—:\n" + err.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- æ ¸å¿ƒè§£æé‚è¼¯ (ä¿æŒä¸è®Š) ---
        function getCorrectIcon(path) {
            if (!path) return "";
            if (path.startsWith('http')) return path;
            let cleanPath = path.replace(/^\//, '');
            if (!cleanPath.includes('.')) cleanPath += '.png';
            return getProxyUrl(cleanPath);
        }

        function getGradeColor(grade) {
            const colors = { 'Myth': '#ff3e3e', 'Unique': '#f90', 'Legend': '#d4b483', 'Epic': '#a335ee', 'Rare': '#0070dd', 'Ancient': '#3fb950' };
            return colors[grade] || 'white';
        }

        // æ¸²æŸ“æ’åè³‡è¨Š
        function renderRankings(rankingList, gameRankings) {
            const container = document.getElementById('p-ranking-container');
            if (!container) return;

            // æ¸…ç©ºå®¹å™¨
            container.innerHTML = '';

            // æ’åé¡å‹å°æ‡‰è¡¨
            const rankingTypes = {
                1: 'æ·±æ·µ',
                3: 'æƒ¡å¤¢',
                4: 'è¶…è¶Š',
                5: 'å­¤ç¨ç«¶æŠ€å ´',
                6: 'å”åŠ›ç«¶æŠ€å ´',
                20: 'è¨ä¼æˆ°',
                21: 'è¦ºé†’æˆ°'
            };

            const rankingIcons = {
                'æ·±æ·µ': 'âš”ï¸',
                'æƒ¡å¤¢': 'ğŸ‘¹',
                'è¶…è¶Š': 'â­',
                'å­¤ç¨ç«¶æŠ€å ´': 'ğŸ¯',
                'å”åŠ›ç«¶æŠ€å ´': 'ğŸ¤',
                'è¨ä¼æˆ°': 'âš¡',
                'è¦ºé†’æˆ°': 'ğŸ’«'
            };

            let hasValidRanking = false;
            let rankings = [];

            // å„ªå…ˆä½¿ç”¨æ–°æ ¼å¼çš„ gameRankings
            if (gameRankings && Object.keys(gameRankings).length > 0) {
                Object.entries(gameRankings).forEach(([typeId, data]) => {
                    if (data && data.rank) {
                        const typeName = rankingTypes[typeId] || `é¡å‹${typeId}`;
                        rankings.push({
                            rankingContentsName: typeName,
                            rank: data.rank,
                            score: data.score,
                            seasonId: data.seasonId
                        });
                        hasValidRanking = true;
                    }
                });
            }
            // å¦‚æœæ²’æœ‰æ–°æ ¼å¼,å˜—è©¦ä½¿ç”¨èˆŠæ ¼å¼çš„ rankingList
            else if (rankingList && rankingList.length > 0) {
                rankingList.forEach(ranking => {
                    if (ranking.rank !== null && ranking.rank !== undefined) {
                        rankings.push(ranking);
                        hasValidRanking = true;
                    }
                });
            }

            if (!hasValidRanking) {
                container.innerHTML = '<div style="color: #8b949e; font-size: 14px; margin-top: 10px;">ğŸ“Š æš«ç„¡æ’åè³‡æ–™</div>';
                return;
            }

            // æ¸²æŸ“æ’åè³‡æ–™
            rankings.forEach(ranking => {
                const badge = document.createElement('div');
                badge.className = 'rank-badge';

                // æ ¹æ“šæ’åé¡å‹è¨­å®šåœ–ç¤º
                const icon = rankingIcons[ranking.rankingContentsName] || 'ğŸ†';

                // è¨ˆç®—æ’åè®ŠåŒ– (æ–°æ ¼å¼æ²’æœ‰ rankChange,æš«æ™‚ä¸é¡¯ç¤º)
                let rankChangeHtml = '';
                if (ranking.rankChange !== null && ranking.rankChange !== undefined && ranking.rankChange !== 0) {
                    const changeClass = ranking.rankChange > 0 ? 'up' : 'down';
                    const changeSymbol = ranking.rankChange > 0 ? 'â–²' : 'â–¼';
                    rankChangeHtml = `<span class="rank-change ${changeClass}">${changeSymbol} ${Math.abs(ranking.rankChange)}</span>`;
                }

                badge.innerHTML = `
                    <div style="font-size: 24px;">${icon}</div>
                    <div class="rank-info">
                        <span class="rank-title">${ranking.rankingContentsName}</span>
                        <span class="rank-val">#${ranking.rank}${rankChangeHtml}</span>
                    </div>
                `;

                container.appendChild(badge);
            });
        }


        // è¼”åŠ©æ¸²æŸ“å‡½æ•¸ (ç¶­æŒä¸è®Š)

        function processData(json, skipScroll = false, skipWingRender = false) {
            // å„²å­˜ç•¶å‰æ•¸æ“šä»¥åˆ©å³æ™‚é‡æ–°æ¸²æŸ“
            window.__LAST_DATA_JSON__ = json;

            // åˆå§‹åŒ–æ‘ºç–Šç‹€æ…‹ï¼ˆé è¨­æ”¶åˆï¼‰
            const wingCollapsed = localStorage.getItem('wingCollectionCollapsed') !== 'false';
            const wrapper = document.getElementById('wing-collection-wrapper');
            const header = document.getElementById('wing-collection-header');
            if (wingCollapsed && wrapper && header) {
                wrapper.classList.add('collapsed');
                header.classList.add('collapsed');
            }

            // å¾ API å›å‚³çš„çµæœä¸­æŠ“å–æ™‚é–“
            const apiUpdateTime = json.queryTimestamp || (json.queryResult ? json.queryResult.queryTimestamp : null);

            // å…¼å®¹ä¸åŒçš„æ•¸æ“šçµæ§‹å±¤æ¬¡
            const data = json.queryResult ? json.queryResult.data : (json.data ? json.data : json);
            if (!data || !data.profile) { alert("ç„¡æ³•åœ¨çµæœä¸­æ‰¾åˆ°æœ‰æ•ˆçš„è§’è‰²æ•¸æ“š!"); return; }

            document.getElementById('main-content').style.display = 'flex';
            document.getElementById('arcana-grid').innerHTML = "";
            document.getElementById('set-bonus-grid').innerHTML = "";
            document.getElementById('stat-body').innerHTML = "";

            document.getElementById('p-name').innerText = data.profile.characterName;
            document.getElementById('p-title-disp').innerText = `[${data.profile.titleName || "ç„¡ç¨±è™Ÿ"}]`;
            document.getElementById('p-img').src = getCorrectIcon(data.profile.profileImage);
            document.getElementById('p-server').innerText = data.profile.serverName;
            document.getElementById('p-lv').innerText = `Lv.${data.profile.characterLevel}`;
            document.getElementById('p-class').innerText = data.profile.className;

            // æ‰¾å‡ºé“å…·ç­‰ç´š
            const itemLvObj = data.stat.statList.find(s => s.type === "ItemLevel");
            document.getElementById('p-itemlv').innerText = itemLvObj ? itemLvObj.value : "--";

            // é¡¯ç¤ºæ›´æ–°æ™‚é–“
            if (apiUpdateTime) {
                const date = new Date(apiUpdateTime);
                document.getElementById('p-update').innerText = date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: false
                });
            } else {
                document.getElementById('p-update').innerText = "API æœªæä¾›æ™‚é–“";
            }

            // æ¸²æŸ“æ’å - æ”¯æ´æ–°èˆŠå…©ç¨®æ ¼å¼
            // æ–°æ ¼å¼: json.gameRankings æˆ– json.queryResult.gameRankings
            // èˆŠæ ¼å¼: data.ranking.rankingList
            const gameRankings = json.gameRankings || (json.queryResult ? json.queryResult.gameRankings : null);
            renderRankings(data.ranking ? data.ranking.rankingList : [], gameRankings);


            let stats = {};
            let boardSkillMap = {};
            let cardSkillMap = {};
            let processedSets = new Set();
            let armorHtml = "";
            let accessoryHtml = "";
            let titleHtml = "";

            const getEntry = (k) => {
                if (!stats[k]) {
                    stats[k] = {
                        nezakan: 0, zikel: 0, baizel: 0, triniel: 0, ariel: 0, asphel: 0,
                        equipMain: 0, equipSub: 0, other: 0,
                        isPerc: k.includes('%'),
                        detailGroups: { base: [], random: [], stone: [], arcana: [], title: [], etc: [], mainStat: [], wing: [], wingHold: [] },
                        subtotals: { title: 0, mainStat: 0, arcana: 0, stone: 0, random: 0, wing: 0, wingHold: 0 }
                    };
                }
                return stats[k];
            };

            // è¼”åŠ©å‡½æ•¸ï¼šæ¨™æº–åŒ–å±¬æ€§åç¨± (å¼·åˆ¶å°‡é€Ÿåº¦é¡å±¬æ€§æ­¸é¡ç‚ºç™¾åˆ†æ¯”)
            const normalizeKey = (name, valStr) => {
                const alwaysPercent = ['æˆ°é¬¥é€Ÿåº¦', 'ç§»å‹•é€Ÿåº¦', 'æ”»æ“Šé€Ÿåº¦'];
                // æª¢æŸ¥åç¨±æ˜¯å¦åŒ…å«é—œéµå­—ï¼Œæˆ–è€…æ•¸å€¼æ˜¯å¦åŒ…å« %
                let isPerc = valStr.toString().includes('%') || alwaysPercent.some(k => name.includes(k));
                // ç§»é™¤åç¨±ä¸­æ—¢æœ‰çš„ % ä»¥é¿å…é‡è¤‡ (ä¾‹å¦‚ "ç§»å‹•é€Ÿåº¦%" -> "ç§»å‹•é€Ÿåº¦")
                // ä½†å¦‚æœ isPerc ç‚ºçœŸï¼Œæœ€å¾ŒæœƒåŠ å› %
                let cleanName = name.replace('%', '');
                return isPerc ? cleanName + '%' : cleanName;
            };

            let mainStatHtml = "";
            (data.stat.statList || []).forEach(s => {
                if (s.type === "ItemLevel") return;
                let details = s.statSecondList ? s.statSecondList.map(d => `â–¹ ${d}`).join('<br>') : "ç„¡é¡å¤–æ•¸æ“š";
                mainStatHtml += `<div class="stat-mini-card"><span style="font-size:12px;color:#8b949e;display:block;">${s.name}</span><span class="stat-mini-val">${s.value}</span><div class="tooltip"><b>${s.name} è©³ç´°è½‰æ›:</b><br>${details}</div></div>`;

                // è§£æ statSecondList ä¸¦åŠ å…¥åˆ°å±¬æ€§å°å¸³ç¸½è¡¨
                if (s.statSecondList && s.statSecondList.length > 0) {
                    if (s.type !== 'ItemLevel') {
                        s.statSecondList.forEach(statDesc => {
                            // è§£ææ ¼å¼: "å±¬æ€§åç¨± +æ•¸å€¼%" æˆ– "å±¬æ€§åç¨± -æ•¸å€¼%"
                            const match = statDesc.match(/^(.+?)\s+([\+\-][\d\.]+%?)$/);
                            if (match) {
                                let statName = match[1].trim();
                                let valueStr = match[2].trim();

                                // ä½¿ç”¨ normalizeKey ç¢ºä¿ key çš„ä¸€è‡´æ€§ (è§£æ±º æˆ°é¬¥é€Ÿåº¦ vs æˆ°é¬¥é€Ÿåº¦% åˆ†é›¢å•é¡Œ)
                                let key = normalizeKey(statName, valueStr);
                                let value = parseFloat(valueStr.replace('%', ''));

                                // å–å¾—æˆ–å»ºç«‹å±¬æ€§é …ç›®
                                let entry = getEntry(key);

                                // åŠ å…¥åˆ° other æ¬„ä½
                                entry.other += value;
                                // æ ¹æ“šä¾†æºè¨˜éŒ„å°è¨ˆ (å¦‚æœæ˜¯æ¿å¡Šå±¬æ€§ s.type æ˜¯ç‰¹æ®Šçš„)
                                // åˆ¤æ–·æ˜¯å¦ç‚ºå…­å¤§æ¿å¡Šæˆ–å±¬æ€§
                                const isAttribute = ['STR', 'DEX', 'INT', 'CON', 'AGI', 'WIS'].includes(s.type);
                                if (isAttribute) {
                                    entry.subtotals.mainStat += value;
                                    entry.detailGroups.mainStat.push(`[${s.name}]è½‰åŒ–: ${valueStr}`);
                                } else {
                                    // å‡è¨­å…¶é¤˜ç‚ºæ¿å¡Š (Time, Justice...)
                                    // é€™è£¡ç„¡æ³•å€åˆ†å…·é«”æ˜¯å“ªå€‹æ¿å¡Šï¼Œä½†å¯ä»¥æ­¸é¡ç‚º Board
                                    // ç”±æ–¼ entry.other å·²ç¶“åŠ äº†ï¼Œæˆ‘å€‘åªéœ€è¦ç¢ºä¿å®ƒé¡¯ç¤ºåœ¨å°çš„åœ°æ–¹
                                    // æš«æ™‚æ¨å…¥ mainStat ä»¥é¡¯ç¤ºåœ¨é ‚éƒ¨ï¼Œæˆ–æ˜¯ random
                                    entry.detailGroups.base.push(`[${s.name.split('[')[0]}]: ${valueStr}`);
                                }
                            }
                        });
                    }
                }
            });
            document.getElementById('stat-main-grid').innerHTML = mainStatHtml;

            // è™•ç†æ¿å¡Šå®Œæˆåº¦è³‡è¨Š
            console.log('æª¢æŸ¥ data.daevanionBoard:', data.daevanionBoard);
            console.log('æª¢æŸ¥ data.daevanionBoardList:', data.daevanionBoardList);

            // å…ˆè¨­å®šé è¨­å…§å®¹
            const boardNames = {
                'nezakan': 'å¥ˆè–©è‚¯',
                'zikel': 'å‰å‡±çˆ¾',
                'baizel': 'ç™½å‚‘çˆ¾',
                'triniel': 'å´”å¦®çˆ¾',
                'ariel': 'è‰¾ç‘çˆ¾',
                'asphel': 'é˜¿æ–¯ä½©çˆ¾'
            };

            // ç‚ºæ¯å€‹æ¿å¡Šè¨­å®šé è¨­æç¤º
            Object.keys(boardNames).forEach(key => {
                const tooltipEl = document.getElementById(`tooltip-${key}`);
                if (tooltipEl) {
                    tooltipEl.innerHTML = `<b>${boardNames[key]} æ¿å¡Š</b><br>è¼‰å…¥ä¸­...`;
                }
            });

            // å˜—è©¦å¾å¤šå€‹å¯èƒ½çš„è·¯å¾‘ç²å–æ¿å¡Šåˆ—è¡¨
            let boardList = null;
            if (data.daevanionBoardList) {
                boardList = data.daevanionBoardList;
                console.log('å¾ data.daevanionBoardList æ‰¾åˆ°è³‡æ–™');
            } else if (data.daevanionBoard && data.daevanionBoard.daevanionBoardList) {
                boardList = data.daevanionBoard.daevanionBoardList;
                console.log('å¾ data.daevanionBoard.daevanionBoardList æ‰¾åˆ°è³‡æ–™');
            }

            // å¦‚æœæœ‰å¯¦éš›è³‡æ–™,å‰‡æ›´æ–°
            if (boardList && boardList.length > 0) {
                const boardMap = {
                    'å¥ˆè–©è‚¯': 'nezakan',
                    'å‰å‡±çˆ¾': 'zikel',
                    'ç™½å‚‘çˆ¾': 'baizel',
                    'å´”å¦®çˆ¾': 'triniel',
                    'è‰¾ç‘çˆ¾': 'ariel',
                    'é˜¿æ–¯ä½©çˆ¾': 'asphel'
                };

                console.log('æ¿å¡Šåˆ—è¡¨:', boardList);
                boardList.forEach(board => {
                    const boardKey = boardMap[board.name];
                    if (boardKey) {
                        const tooltipEl = document.getElementById(`tooltip-${boardKey}`);
                        if (tooltipEl) {
                            const content = `<b>${board.name} æ¿å¡Šå®Œæˆåº¦</b><br>å·²é–‹å•Ÿç¯€é»: ${board.openNodeCount} / ${board.totalNodeCount}<br>å®Œæˆåº¦: ${board.openPercent}%`;
                            tooltipEl.innerHTML = content;
                            console.log(`âœ“ å·²è¨­å®š ${board.name} tooltip`);
                        } else {
                            console.warn(`âœ— æ‰¾ä¸åˆ° tooltip å…ƒç´ : tooltip-${boardKey}`);
                        }
                    }
                });
            } else {
                console.warn('API æœªæä¾› daevanionBoardList è³‡æ–™');
            }

            (data.daevanionDetails || []).forEach(b => {

                (b.detail?.openStatEffectList || []).forEach(ef => {
                    let parts = ef.desc.split(' +'); if (parts.length < 2) return;
                    let n = parts[0], vS = parts[1];
                    let k = vS.includes('%') ? n.trim() + '%' : n.trim(), v = parseFloat(vS.replace('%', '')), e = getEntry(k);
                    if (b.boardName.includes("å¥ˆè–©è‚¯")) e.nezakan += v;
                    else if (b.boardName.includes("å‰å‡±çˆ¾")) e.zikel += v;
                    else if (b.boardName.includes("ç™½å‚‘çˆ¾")) e.baizel += v;
                    else if (b.boardName.includes("å´”å¦®çˆ¾")) e.triniel += v;
                    else if (b.boardName.includes("è‰¾ç‘çˆ¾")) e.ariel += v;
                    else if (b.boardName.includes("é˜¿æ–¯ä½©çˆ¾")) e.asphel += v;
                    else {
                        // å…¶ä»–æ–°æ¿å¡Š (å¸ŒåŸƒçˆ¾ã€ç‘ªçˆ¾åº«å¦ã€å‡±è¥¿å…§çˆ¾ç­‰) 
                        // æš«æ™‚æ­¸å…¥ otherï¼Œä½†åœ¨è©³ç´°è³‡è¨Šä¸­æ¨™æ˜
                        e.other += v;
                        // ä¸åŠ å…¥ subtotals.wing æˆ–å…¶ä»–åˆ†é¡ï¼Œè®“å®ƒé¡¯ç¤ºåœ¨"å…¶ä»–åŠ æˆ"
                        // æˆ–è€…æˆ‘å€‘å¯ä»¥æ–°å¢ä¸€å€‹ subtotals.boardOther

                        // ç‚ºäº†è®“ tooltip é¡¯ç¤ºï¼Œæˆ‘å€‘æ‰‹å‹•åŠ å…¥åˆ° board çš„è©³ç´°è³‡è¨Šä¸­
                        // é€™è£¡æ¯”è¼ƒç‰¹æ®Šï¼Œå› ç‚ºæˆ‘å€‘æ²’æœ‰ boardOther çš„åˆ†é¡ï¼Œ
                        // æ‰€ä»¥æˆ‘å€‘å°‡ç”± detailGroups.etc æ”¶é›†ï¼Œæˆ–è€…ç›´æ¥åœ¨ otherMisc è¨ˆç®—æ™‚æœƒé¡¯ç¤º

                        // æ›´å¥½çš„æ–¹å¼ï¼šç›´æ¥ç•¶ä½œ"å…¶ä»–æ¿å¡Š"åŠ å…¥
                        // ä½†é€™éœ€è¦ä¿®æ”¹ renderStatTable çš„é‚è¼¯

                        // ç›®å‰å…ˆç¢ºä¿æ•¸æ“šæœ‰è¢«åŠ ç¸½ï¼š
                        // é€™äº›æ•¸æ“šæœƒé€²å…¥ stats[k].other -> getStatObj -> total
                        // æ‰€ä»¥æˆ°é¬¥åˆ†ææœƒæ­£ç¢º

                        // åœ¨å°å¸³è¡¨çš„ tooltip ä¸­ï¼Œå®ƒæœƒå‡ºç¾åœ¨"å…¶ä»–åŠ æˆ"
                    }
                });
                (b.detail?.openSkillEffectList || []).forEach(sk => {
                    let [sn, sv] = sk.desc.split(' +');
                    boardSkillMap[sn] = (boardSkillMap[sn] || 0) + parseInt(sv);
                });
            });

            (data.title?.titleList || []).forEach(t => {
                if (t.equipCategory) {
                    let catName = t.equipCategory === "Attack" ? "âš”ï¸ æ”»æ“Šç¨±è™Ÿ" : "ğŸ›¡ï¸ é˜²ç¦¦ç¨±è™Ÿ";
                    titleHtml += `<div class="title-box"><span class="title-label">${catName}</span><span class="title-val">${t.name}</span><div class="title-desc">${(t.equipStatList || []).map(ef => `â–¹ ${ef.desc}`).join('<br>')}</div></div>`;
                    (t.equipStatList || []).forEach(ef => {
                        let parts = ef.desc.split(' +'); if (parts.length < 2) return;
                        let n = parts[0], vS = parts[1];
                        let k = vS.includes('%') ? n.trim() + '%' : n.trim(), v = parseFloat(vS.replace('%', '')), e = getEntry(k);
                        e.other += v;
                        e.subtotals.title += v;
                        e.detailGroups.title.push(`[${t.name}]: +${vS}`);
                    });
                }
            });
            document.getElementById('title-grid').innerHTML = titleHtml || "<div style='color:#8b949e; padding:10px;'>æœªè£å‚™ç¨±è™Ÿ</div>";

            // è™•ç†å¯µç‰©èˆ‡ç¿…è†€
            let petwingHtml = "";
            if (data.petwing) {
                // è™•ç†å¯µç‰©
                if (data.petwing.pet) {
                    const pet = data.petwing.pet;
                    const petName = pet.name || "æš«ç„¡";
                    const petLevel = pet.level ? `Lv.${pet.level}` : "æš«ç„¡";
                    const petIcon = pet.icon ? getCorrectIcon(pet.icon) : "";

                    petwingHtml += `<div class="info-box" style="border-left: 4px solid var(--blue); display: flex; gap: 10px;">
                        ${petIcon ? `<img src="${petIcon}" style="width: 64px; height: 64px; border-radius: 8px; border: 2px solid var(--blue);">` : ''}
                        <div style="flex-grow: 1;">
                            <div class="box-header" style="color:var(--blue)">ğŸ¾ å¯µç‰©</div>
                            <div style="font-size:14px; font-weight:bold; color:#fff; margin-top:5px;">${petName}</div>
                            <div style="font-size:12px; color:var(--gold); margin-top:3px;">ç­‰ç´š: ${petLevel}</div>
                        </div>
                    </div>`;
                }

                // è™•ç†ç¿…è†€
                if (data.petwing.wing) {
                    const wing = data.petwing.wing;
                    const wingName = wing.name || "æš«ç„¡";

                    // å“è³ªç¿»è­¯å°æ‡‰è¡¨
                    const gradeTranslation = {
                        'Myth': 'ç¥è©±', 'Unique': 'å”¯ä¸€', 'Legend': 'å‚³èªª', 'Epic': 'å²è©©', 'Rare': 'ç¨€æœ‰', 'Ancient': 'å¤ä»£'
                    };
                    const wingGrade = wing.grade ? (gradeTranslation[wing.grade] || wing.grade) : "æš«ç„¡";
                    const wingEnchant = (wing.enchantLevel !== undefined && wing.enchantLevel !== null) ? `+${wing.enchantLevel}` : "";
                    const gradeColor = wing.grade ? getGradeColor(wing.grade) : "var(--gold)";
                    const wingIcon = wing.icon ? getCorrectIcon(wing.icon) : "";

                    // æ¯”å°è³‡æ–™åº«ç²å–å±¬æ€§
                    let wingBonusHtml = "";
                    let matchedWing = null;
                    for (let key in WING_DATABASE) {
                        if (wingName.includes(key)) {
                            matchedWing = WING_DATABASE[key];
                            break;
                        }
                    }

                    if (matchedWing) {
                        const applyStats = (statObj, typeLabel) => {
                            for (let statName in statObj) {
                                let val = statObj[statName];
                                let absVal = Math.abs(val);
                                let isDecimal = (absVal > 0 && absVal < 1);

                                // æ ¹æ“šé—œéµå­—å¼·åˆ¶è¦–ç‚ºç™¾åˆ†æ¯” (é™¤äº†å°æ•¸åˆ¤å®šå¤–)
                                const percentKeywords = ['å¢å¹…', 'å¢åŠ ', 'æ¸›å°‘', 'ç‡', 'è€æ€§'];
                                const matchesKeyword = percentKeywords.some(k => statName.includes(k));

                                if (isDecimal) val = val * 100;

                                // æ¨™æº–åŒ–å±¬æ€§åç¨± (å»é™¤ "é¡å¤–" å‰ç¶´)
                                let normName = statName.replace(/^é¡å¤–/, '');

                                // è‹¥æ˜¯å°æ•¸è½‰æ›è€Œä¾†ï¼Œæˆ–åç¨±åŒ…å«ç™¾åˆ†æ¯”é—œéµå­—ï¼Œå‰‡ç¢ºä¿åç¨±æœ‰ %
                                if ((isDecimal || matchesKeyword) && !normName.includes('%')) {
                                    normName += '%';
                                }

                                let entry = getEntry(normName);
                                entry.other += val;
                                entry.subtotals.wing += val;

                                const unit = normName.includes('%') ? '%' : '';
                                entry.detailGroups.wing.push(`[${wingName}](${typeLabel}): +${parseFloat(val.toFixed(2))}${unit}`);
                                wingBonusHtml += `<div style="font-size:11px; color:var(--green)">âš¡ ${typeLabel}-${normName}: +${parseFloat(val.toFixed(2))}${unit}</div>`;
                            }
                        };
                        if (matchedWing.equip) applyStats(matchedWing.equip, "è£å‚™");
                    } else {
                        wingBonusHtml = `<div style="font-size:11px; color:#8b949e">âš¡ æ­¤ç¿…è†€æš«ç„¡è³‡æ–™åº«åŠ æˆ (åƒ…å¤–å‹)</div>`;
                    }

                    petwingHtml += `<div class="info-box" style="border-left: 4px solid ${gradeColor}; display: flex; gap: 10px;">
                        ${wingIcon ? `<img src="${wingIcon}" style="width: 64px; height: 64px; border-radius: 8px; border: 2px solid ${gradeColor};">` : ''}
                        <div style="flex-grow: 1;">
                            <div class="box-header" style="color:${gradeColor}">ğŸª½ ç¿…è†€</div>
                            <div style="font-size:14px; font-weight:bold; color:${gradeColor}; margin-top:5px;">${wingEnchant} ${wingName}</div>
                            <div style="font-size:12px; color:#8b949e; margin-top:3px;">å“è³ª: ${wingGrade}</div>
                            ${wingBonusHtml}
                        </div>
                    </div>`;
                }
            }
            document.getElementById('petwing-grid').innerHTML = petwingHtml || "<div style='color:#8b949e; padding:10px;'>ç„¡å¯µç‰©æˆ–ç¿…è†€è³‡æ–™</div>";

            // è™•ç†æŒæœ‰ç¿…è†€çš„æ•ˆæœï¼ˆå¾æ”¶è—ç³»çµ±ï¼‰
            const ownedWings = JSON.parse(localStorage.getItem('ownedWings') || '[]');
            ownedWings.forEach(wingName => {
                const wing = WING_DATABASE[wingName];
                if (wing && wing.hold) {
                    for (let statName in wing.hold) {
                        let val = wing.hold[statName];
                        let absVal = Math.abs(val);
                        let isDecimal = (absVal > 0 && absVal < 1);

                        // æ ¹æ“šé—œéµå­—å¼·åˆ¶è¦–ç‚ºç™¾åˆ†æ¯” (é™¤äº†å°æ•¸åˆ¤å®šå¤–)
                        const percentKeywords = ['å¢å¹…', 'å¢åŠ ', 'æ¸›å°‘', 'ç‡', 'è€æ€§'];
                        const matchesKeyword = percentKeywords.some(k => statName.includes(k));

                        if (isDecimal) val = val * 100;

                        // æ¨™æº–åŒ–å±¬æ€§åç¨± (å»é™¤ "é¡å¤–" å‰ç¶´)
                        let normName = statName.replace(/^é¡å¤–/, '');

                        // è‹¥æ˜¯å°æ•¸è½‰æ›è€Œä¾†ï¼Œæˆ–åç¨±åŒ…å«ç™¾åˆ†æ¯”é—œéµå­—ï¼Œå‰‡ç¢ºä¿åç¨±æœ‰ %
                        if ((isDecimal || matchesKeyword) && !normName.includes('%')) {
                            normName += '%';
                        }

                        let entry = getEntry(normName);
                        entry.other += val;
                        entry.subtotals.wingHold += val;

                        const unit = normName.includes('%') ? '%' : '';
                        entry.detailGroups.wingHold.push(`[${wingName}](æŒæœ‰): +${parseFloat(val.toFixed(2))}${unit}`);
                    }
                }
            });

            const equipMap = {};
            (data.equipment ? data.equipment.equipmentList : []).forEach(item => { equipMap[item.slotPos] = item; });
            (data.itemDetails || []).forEach(i => {
                const d = i.detail; if (!d) return;
                const slot = i.slotPos;
                const isArmor = (slot >= 1 && slot <= 8) || slot === 21;
                const isAccessory = (slot >= 9 && slot <= 20) || (slot >= 22 && slot <= 40);
                const isArcana = (slot >= 41 && slot <= 45);
                const originalItem = equipMap[slot] || i;
                const finalIcon = getCorrectIcon(originalItem.icon);

                if (d.set && !processedSets.has(d.set.name)) {
                    processedSets.add(d.set.name);
                    document.getElementById('set-bonus-grid').innerHTML += `<div class="info-box"><div class="box-header">ğŸ”± å¥—è£ï¼š${d.set.name}</div>${d.set.bonuses.map(b => `<div style="margin-bottom:8px; padding-left:10px; border-left:2px solid var(--blue)"><span style="color:var(--blue); font-weight:bold;">[${b.degree}ä»¶æ•ˆæœ]</span><br><span style="color:#e6edf3; font-size:12px;">${b.descriptions.join('ã€')}</span></div>`).join('')}</div>`;
                }

                if (isArcana) {
                    const gradeColor = getGradeColor(d.grade);
                    let arcanaStatsHtml = (d.mainStats || []).map(ms => `<div>${ms.name} +${ms.value}</div>`).join('');
                    let arcanaSubStatsHtml = (d.subStats || []).map(ss => `<div style="color:var(--green)">åˆ»å°: ${ss.name} +${ss.value}</div>`).join('');
                    let arcanaSkillsHtml = (d.subSkills || []).map(sk => `<div style="color:var(--blue)">${sk.name} Lv.${sk.level}</div>`).join('');
                    document.getElementById('arcana-grid').innerHTML += `<div class="info-box" style="border-left: 4px solid ${gradeColor}; display: flex; gap: 10px;"><img src="${getCorrectIcon(originalItem.icon)}" style="width: 44px; height: 44px; border-radius: 4px;"><div style="flex-grow: 1;"><div class="box-header" style="color:${gradeColor}">+${i.enchantLevel} ${d.name}</div><div style="font-size:12px;">${arcanaStatsHtml}</div><div style="font-size:11px;">${arcanaSubStatsHtml}</div><div style="font-size:11px;">${arcanaSkillsHtml}</div></div></div>`;
                    (d.subSkills || []).forEach(sk => { if (!cardSkillMap[sk.name]) cardSkillMap[sk.name] = []; cardSkillMap[sk.name].push({ name: d.name, lv: sk.level }); });
                    (d.mainStats || []).forEach(ms => {
                        let e = getEntry(ms.name);
                        let val = parseFloat(ms.value);
                        e.other += val;
                        e.subtotals.arcana += val;
                        e.detailGroups.arcana.push(`${d.name}(ä¸»): +${ms.value}`);
                    });
                    (d.subStats || []).forEach(ss => {
                        let k = ss.value.toString().includes('%') ? ss.name + '%' : ss.name;
                        let e = getEntry(k);
                        let val = parseFloat(ss.value.toString().replace('%', ''));
                        e.other += val;
                        e.subtotals.arcana += val;
                        e.detailGroups.arcana.push(`${d.name}(åˆ»): +${ss.value}`);
                    });
                }

                if (isArmor || isAccessory) {
                    let gradeColor = getGradeColor(d.grade);
                    let exceedBadge = (originalItem.exceedLevel || 0) > 0 ? `<div class="exceed-badge">${originalItem.exceedLevel}</div>` : "";
                    let mainStatsD = (d.mainStats || []).map(s => `<div class="base-stat-row"><b>${s.name} ${(parseFloat(s.value) || 0) + (parseFloat(s.extra) || 0)}</b>${(parseFloat(s.extra) > 0) ? ` <span style="color:var(--green);">(+${s.extra})</span>` : ""}</div>`).join('');
                    let godStoneHtml = (d.godStoneStat || []).map(gs => `<div style="margin-top: 5px; border: 1px dashed #00d4ff; padding: 4px; font-size:11px; border-radius:4px;"><b style="color:#00d4ff">${gs.name}</b><br>${gs.desc}</div>`).join('');
                    let cardHtml = `<div class="equip-item-card" style="border-top-color: ${gradeColor}; border-left: 4px solid ${gradeColor};"><div class="equip-left-section"><div style="display:flex; align-items:center; gap:10px;"><div class="equip-img-container"><img src="${finalIcon}">${exceedBadge}</div><div><span class="equip-name" style="color:${gradeColor}">${d.name}</span><div><span style="color:#fff; font-weight:bold;">+${i.enchantLevel}</span></div></div></div><div style="margin-top:8px;">${mainStatsD}</div></div><div class="equip-right-section"><div style="color:#8b949e; font-size:10px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:5px;">é™„åŠ å±¬æ€§/ç¥çŸ³</div>${(d.subStats || []).map(s => `<div class="random-row"><span>${s.name}</span><span>+${s.value}</span></div>`).join('')}${(d.subSkills || []).map(sk => `<div class="skill-badge-mini">${sk.name} Lv.${sk.level}</div>`).join('')}${godStoneHtml}${(d.magicStoneStat || []).map(ms => `<div class="random-row" style="color:var(--gold); font-size:11px;"><span>[ç£¨çŸ³] ${ms.name}</span><span>${ms.value}</span></div>`).join('')}</div></div>`;
                    if (isArmor) armorHtml += cardHtml; else accessoryHtml += cardHtml;
                    let mainStatAcc = {};

                    // è¼”åŠ©å‡½æ•¸ï¼šæ¨™æº–åŒ–å±¬æ€§åç¨± (å¼·åˆ¶å°‡é€Ÿåº¦é¡å±¬æ€§æ­¸é¡ç‚ºç™¾åˆ†æ¯”)
                    const normalizeKey = (name, valStr) => {
                        const alwaysPercent = ['æˆ°é¬¥é€Ÿåº¦', 'ç§»å‹•é€Ÿåº¦'];
                        // æª¢æŸ¥åç¨±æ˜¯å¦åŒ…å«é—œéµå­—ï¼Œæˆ–è€…æ•¸å€¼æ˜¯å¦åŒ…å« %
                        let isPerc = valStr.toString().includes('%') || alwaysPercent.some(k => name.includes(k));
                        // ç§»é™¤åç¨±ä¸­æ—¢æœ‰çš„ % ä»¥é¿å…é‡è¤‡ (ä¾‹å¦‚ "ç§»å‹•é€Ÿåº¦%" -> "ç§»å‹•é€Ÿåº¦")
                        let cleanName = name.replace('%', '');
                        return isPerc ? cleanName + '%' : cleanName;
                    };

                    (d.mainStats || []).forEach(ms => {
                        // è™•ç†åŸºç¤å€¼
                        let baseVal = parseFloat(ms.value.toString().replace('%', '') || 0);
                        let baseKey = normalizeKey(ms.name, ms.value);
                        let isBasePerc = baseKey.includes('%'); // é‡æ–°ç¢ºèªæœ€çµ‚ key æ˜¯å¦ç‚º %

                        // è™•ç†é¡å¤–å€¼ (å¼·åŒ–ç­‰)
                        let extraVal = parseFloat(ms.extra?.toString().replace('%', '') || 0);
                        let extraKey = normalizeKey(ms.name, ms.extra || '');
                        let isExtraPerc = extraKey.includes('%');

                        // --- 1. ç´¯åŠ åˆ°å…¨å±€çµ±è¨ˆ (ç”¨æ–¼è¨ˆç®—ç¸½æ•¸) ---
                        let eBase = getEntry(baseKey);
                        eBase.equipMain += baseVal;

                        if (extraVal > 0) {
                            let eExtra = getEntry(extraKey);
                            eExtra.equipMain += extraVal;
                        }

                        // --- 2. ç´¯åŠ åˆ°å–®å“é …çµ±è¨ˆ (ç”¨æ–¼ Tooltip é¡¯ç¤ºæ•´åˆ) ---
                        // è™•ç† Base
                        if (!mainStatAcc[baseKey]) mainStatAcc[baseKey] = { total: 0, base: 0, enchant: 0, exceed: 0, isPerc: isBasePerc };
                        mainStatAcc[baseKey].total += baseVal;
                        mainStatAcc[baseKey].base += baseVal;

                        // è™•ç† Extra
                        if (extraVal > 0) {
                            if (!mainStatAcc[extraKey]) mainStatAcc[extraKey] = { total: 0, base: 0, enchant: 0, exceed: 0, isPerc: isExtraPerc };
                            mainStatAcc[extraKey].total += extraVal;
                            if (ms.exceed) mainStatAcc[extraKey].exceed += extraVal;
                            else mainStatAcc[extraKey].enchant += extraVal;
                        }
                    });

                    // å°‡æ•´åˆå¾Œçš„å–®å“é …æ•¸æ“šå¯«å…¥ detailGroups
                    for (let k in mainStatAcc) {
                        let info = mainStatAcc[k];
                        let parts = [];
                        // åƒ…ç•¶æœ‰ç´°é …æ™‚æ‰é¡¯ç¤ºæ‹¬è™Ÿå…§å®¹
                        if (info.base > 0) parts.push(`åŸº+${parseFloat(info.base.toFixed(2))}`);
                        if (info.enchant > 0) parts.push(`å¼·+${parseFloat(info.enchant.toFixed(2))}`);
                        if (info.exceed > 0) parts.push(`çª+${parseFloat(info.exceed.toFixed(2))}`); // çªç ´

                        let unit = info.isPerc ? '%' : '';
                        let str = `+${i.enchantLevel} ${d.name}: +${parseFloat(info.total.toFixed(2))}${unit}`;

                        // å¦‚æœæœ‰ç´°é …ä¸”ç¸½æ•¸ä¸ç­‰æ–¼å–®ä¸€ç´°é …(é¿å…å–®ä¸€ä¾†æºæ™‚é‡è¤‡é¡¯ç¤º)
                        if (parts.length > 0 && !(parts.length === 1 && info.total === (info.base || info.enchant || info.exceed))) {
                            str += ` <span style="font-size:11px; color:#8b949e">(${parts.join(' ')})</span>`;
                        }

                        getEntry(k).detailGroups.base.push(str);
                    }
                    (d.subStats || []).forEach(ss => {
                        if (!ss.value) return;
                        let k = normalizeKey(ss.name, ss.value);
                        let v = parseFloat(ss.value.toString().replace('%', '')) || 0;
                        let e = getEntry(k);
                        e.equipSub += v;
                        e.subtotals.random += v;
                        e.detailGroups.random.push(`${d.name}: +${ss.value}`);
                    });
                    (d.magicStoneStat || []).forEach(ms => {
                        if (!ms.value) return;
                        let k = normalizeKey(ms.name, ms.value);
                        let v = parseFloat(ms.value.toString().replace('%', '')) || 0;
                        let e = getEntry(k);
                        e.equipSub += v;
                        e.subtotals.stone += v;
                        e.detailGroups.stone.push(`${d.name}: ${ms.value}`);
                    });
                }
            });

            document.getElementById('equip-armor-list').innerHTML = armorHtml || "<div>ç„¡è³‡æ–™</div>";
            document.getElementById('equip-accessory-list').innerHTML = accessoryHtml || "<div>ç„¡è³‡æ–™</div>";
            renderSkills(data, boardSkillMap, cardSkillMap);
            if (!skipWingRender) renderWingCollection(stats);
            renderStatTable(stats);
            renderCombatAnalysis(stats, data);

            if (!skipScroll) {
                window.scrollTo({ top: document.getElementById('main-content').offsetTop - 20, behavior: 'smooth' });
            }
        }

        function renderRankings(rankList) {
            const container = document.getElementById('p-ranking-container');
            container.innerHTML = "";
            rankList.forEach(r => {
                if (!r.rank) return;
                let changeHtml = r.rankChange > 0 ? `<span class="rank-change up">â–²${r.rankChange}</span>` : (r.rankChange < 0 ? `<span class="rank-change down">â–¼${Math.abs(r.rankChange)}</span>` : "");
                container.innerHTML += `<div class="rank-badge"><img src="${r.gradeIcon}"><div class="rank-info"><span class="rank-title">${r.rankingContentsName}</span><span class="rank-val">${r.rank} ä½ ${changeHtml}</span></div></div>`;
            });
        }

        // ç¿…è†€æ”¶è—ç³»çµ±æ¸²æŸ“å‡½æ•¸
        function renderWingCollection(stats) {
            const grid = document.getElementById('wing-collection-grid');
            if (!grid) return;

            // å¾ localStorage è®€å–å·²å‹¾é¸çš„ç¿…è†€
            const savedWings = JSON.parse(localStorage.getItem('ownedWings') || '[]');

            let html = '';
            Object.keys(WING_DATABASE).forEach(wingName => {
                const wing = WING_DATABASE[wingName];
                const isChecked = savedWings.includes(wingName);
                const checkboxId = `wing-${wingName.replace(/\s+/g, '-')}`;

                // ç”ŸæˆæŒæœ‰æ•ˆæœç´°é …
                let holdStatsHtml = '';
                if (wing.hold && Object.keys(wing.hold).length > 0) {
                    holdStatsHtml = Object.entries(wing.hold).map(([statName, value]) => {
                        return `<div style="font-size:10px; color:var(--green);">â–¹ ${statName}: +${value}${statName.includes('%') ? '' : ''}</div>`;
                    }).join('');
                }

                html += `
                    <div style="background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:8px; padding:12px;">
                        <label style="display:flex; align-items:flex-start; gap:8px; cursor:pointer;">
                            <input type="checkbox" 
                                   id="${checkboxId}" 
                                   value="${wingName}" 
                                   ${isChecked ? 'checked' : ''}
                                   onchange="toggleWingOwnership('${wingName}', this.checked)"
                                   style="margin-top:2px; cursor:pointer;">
                            <div style="flex:1;">
                                <div style="font-weight:bold; color:#fff; margin-bottom:5px;">ğŸª½ ${wingName}</div>
                                ${holdStatsHtml || '<div style="font-size:10px; color:#8b949e;">ç„¡æŒæœ‰æ•ˆæœ</div>'}
                            </div>
                        </label>
                    </div>
                `;
            });

            grid.innerHTML = html;
        }

        // åˆ‡æ›ç¿…è†€æŒæœ‰ç‹€æ…‹
        function toggleWingOwnership(wingName, isOwned) {
            let ownedWings = JSON.parse(localStorage.getItem('ownedWings') || '[]');

            if (isOwned) {
                if (!ownedWings.includes(wingName)) {
                    ownedWings.push(wingName);
                }
            } else {
                ownedWings = ownedWings.filter(w => w !== wingName);
            }

            localStorage.setItem('ownedWings', JSON.stringify(ownedWings));

            // å¦‚æœå·²æœ‰å¿«å–æ•¸æ“šï¼Œç«‹å³é‡æ–°è™•ç† UIï¼Œä½†ä¸é‡æ–°æ¸²æŸ“ç¿…è†€æ¸…å–®ä»¥é˜²é–ƒçˆ
            if (window.__LAST_DATA_JSON__) {
                processData(window.__LAST_DATA_JSON__, true, true);
            } else {
                // æç¤ºä½¿ç”¨è€…é‡æ–°æŸ¥è©¢ä»¥æ›´æ–°æ•¸æ“š
                const btn = document.querySelector('.btn-api');
                if (btn) {
                    btn.style.animation = 'pulse 0.5s ease-in-out 3';
                    btn.textContent = 'ğŸ”„ è«‹é‡æ–°æŸ¥è©¢ä»¥æ›´æ–°æ•¸æ“š';
                    setTimeout(() => {
                        btn.textContent = 'ç«‹å³æŸ¥è©¢';
                    }, 3000);
                }
            }
        }

        // åˆ‡æ›ç¿…è†€æ”¶è—ç³»çµ±æ‘ºç–Šç‹€æ…‹
        function toggleWingCollection() {
            const wrapper = document.getElementById('wing-collection-wrapper');
            const header = document.getElementById('wing-collection-header');
            if (!wrapper || !header) return;

            const isNowCollapsed = wrapper.classList.toggle('collapsed');
            header.classList.toggle('collapsed');
            localStorage.setItem('wingCollectionCollapsed', isNowCollapsed);
        }

        function renderSkills(data, boardSkillMap, cardSkillMap) {
            let act = "", pas = "", sti = "";
            data.skill.skillList.forEach(s => {
                let bLv = boardSkillMap[s.name] || 0;
                let cLv = (cardSkillMap[s.name] || []).reduce((a, b) => a + b.lv, 0);
                let tip = `<div class="tooltip"><b>${s.name}</b><br>åŸºç¤: Lv.${Math.max(0, s.skillLevel - bLv - cLv)}<br>æ¿å¡Š: +${bLv}<br>å¡ç‰‡: +${cLv}</div>`;
                let h = `<div class="skill-card"><img src="${getCorrectIcon(s.icon)}"><div><span class="sk-name">${s.name}</span><span style="color:var(--blue);font-size:14px">Lv.${s.skillLevel}</span></div>${tip}</div>`;
                if (s.category === "Active") act += h; else if (s.category === "Passive") pas += h; else sti += h;
            });
            document.getElementById('sk-act').innerHTML = act; document.getElementById('sk-pas').innerHTML = pas; document.getElementById('sk-stigma').innerHTML = sti;
        }


        function renderCombatAnalysis(stats, data) {
            const grid = document.getElementById('combat-stats-grid');
            if (!grid) return;

            const getStatObj = (key) => {
                // æ™ºèƒ½åŒ¹é…: å˜—è©¦ç²¾ç¢ºåŒ¹é…,å¦‚æœå¤±æ•—å‰‡å˜—è©¦ç§»é™¤%å¾ŒåŒ¹é…
                let s = stats[key];

                // å¦‚æœæ‰¾ä¸åˆ°,å˜—è©¦ç§»é™¤æˆ–æ·»åŠ  % ç¬¦è™Ÿ
                if (!s) {
                    if (key.includes('%')) {
                        // å¦‚æœæŸ¥è©¢çš„ key æœ‰ %,å˜—è©¦ç§»é™¤ % æŸ¥æ‰¾
                        const keyWithoutPercent = key.replace(/%/g, '').trim();
                        s = stats[keyWithoutPercent];
                    } else {
                        // å¦‚æœæŸ¥è©¢çš„ key æ²’æœ‰ %,å˜—è©¦æ·»åŠ  % æŸ¥æ‰¾
                        const keyWithPercent = key + '%';
                        s = stats[keyWithPercent];
                    }
                }

                // å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°è©²å±¬æ€§ï¼Œå›å‚³ 0
                if (!s) {
                    return {
                        total: 0,
                        s: {
                            base: 0, equipMain: 0, equipSub: 0, other: 0,
                            subtotals: { mainStat: 0, random: 0, stone: 0, wing: 0, wingHold: 0, arcana: 0, set: 0, title: 0 },
                            detailGroups: { base: [], random: [], stone: [], wing: [], wingHold: [], arcana: [], set: [], title: [], other: [] }
                        }
                    };
                }

                // è¤‡è£½ s (åŒ…å«æ¿å¡Šæ•¸å€¼)
                let e = {
                    base: s.base || 0,
                    equipMain: s.equipMain || 0,
                    equipSub: s.equipSub || 0,
                    other: s.other || 0,
                    nezakan: s.nezakan || 0,
                    zikel: s.zikel || 0,
                    baizel: s.baizel || 0,
                    triniel: s.triniel || 0,
                    ariel: s.ariel || 0,
                    asphel: s.asphel || 0,
                    subtotals: { ...(s.subtotals || {}) },
                    detailGroups: { ...(s.detailGroups || {}) }
                };
                if (!e.detailGroups.other) e.detailGroups.other = [];

                // è¨ˆç®—æœ€çµ‚ç¸½å’Œ (åŒ…å«æ¿å¡Š)
                const boardTotal = e.nezakan + e.zikel + e.baizel + e.triniel + e.ariel + e.asphel;
                const total = e.base + e.equipMain + e.equipSub + e.other + boardTotal;

                return {
                    total: parseFloat(total.toFixed(2)),
                    s: {
                        ...e,
                        subtotals: {
                            ...e.subtotals
                        },
                        isPerc: key.includes('%') || (s.isPerc || false)
                    }
                };
            };

            // ä¿®æ­£ fmt å‡½æ•¸ä»¥é¿å…å ±éŒ¯
            const fmt = (v, isPerc) => (Number(parseFloat(v || 0).toFixed(2)) + (isPerc ? '%' : ''));

            const analysisItems = [
                { title: "æ”»æ“ŠåŠ›", baseKey: "æ”»æ“ŠåŠ›", percKey: "æ”»æ“ŠåŠ›å¢åŠ %", icon: "âš”ï¸", desc: "æœ€çµ‚æ”»æ“Šè¡¨ç¾ = åŸºç¤å›ºå®šå€¼ Ã— (1 + æ”»æ“Šå¢åŠ %)" },
                { title: "å‘½ä¸­", baseKey: "å‘½ä¸­", percKey: "å‘½ä¸­å¢åŠ %", icon: "ğŸ¯", desc: "å½±éŸ¿ç‰©ç†èˆ‡é­”æ³•æ”»æ“Šçš„å‘½ä¸­ç‡ã€‚" },
                { title: "æš´æ“Š", baseKey: "æš´æ“Š", percKey: "æš´æ“Šå¢åŠ %", icon: "ğŸ’¥", desc: "å½±éŸ¿è‡´å‘½ä¸€æ“Šçš„ç™¼å‹•æ©Ÿç‡ã€‚" },
                { title: "ç”Ÿå‘½åŠ›", baseKey: "ç”Ÿå‘½åŠ›", percKey: "ç”Ÿå‘½åŠ›å¢åŠ %", icon: "â¤ï¸", desc: "è§’è‰²çš„æœ€å¤§ç”Ÿå­˜é»æ•¸ã€‚" },
                { title: "æˆ°é¬¥é€Ÿåº¦", baseKey: "æˆ°é¬¥é€Ÿåº¦%", percKey: null, icon: "âš¡", desc: "æ”»æ“Šé€Ÿåº¦èˆ‡æ–½æ³•é€Ÿåº¦çš„è¡¨ç¾ã€‚" },
                { title: "é˜²ç¦¦åŠ›", baseKey: "é˜²ç¦¦åŠ›", percKey: "é˜²ç¦¦åŠ›å¢åŠ %", icon: "ğŸ›¡ï¸", desc: "æ¸›å…å—åˆ°ç‰©ç†å‚·å®³çš„èƒ½åŠ›ã€‚" },
                { title: "è¿´é¿", baseKey: "è¿´é¿", percKey: "è¿´é¿å¢åŠ %", icon: "ğŸƒ", desc: "å®Œå…¨é–ƒé¿æ•µæ–¹æ”»æ“Šçš„æ©Ÿç‡ã€‚" },
                { title: "æ ¼æ“‹", baseKey: "æ ¼æ“‹", percKey: "æ ¼æ“‹å¢åŠ %", icon: "ğŸ›¡ï¸", desc: "ä½¿ç”¨æ­¦å™¨æˆ–ç›¾ç‰ŒæŠµæ“‹å‚·å®³ã€‚" },
                { title: "æš´æ“ŠæŠµæŠ—", baseKey: "æš´æ“ŠæŠµæŠ—", percKey: "æš´æ“ŠæŠµæŠ—å¢åŠ %", icon: "ğŸ›¡ï¸", desc: "é™ä½å—åˆ°æš´æ“Šçš„æ©Ÿç‡èˆ‡å‚·å®³ã€‚" },
                { title: "ç•°å¸¸ç‹€æ…‹æ“Šä¸­", baseKey: "ç•°å¸¸ç‹€æ…‹æ“Šä¸­", percKey: null, icon: "ğŸ¯", desc: "æˆåŠŸå°æ•µäººæ–½åŠ ç‹€æ…‹ç•°å¸¸çš„æ©Ÿç‡ã€‚" },
                { title: "ç•°å¸¸ç‹€æ…‹æŠµæŠ—", baseKey: "ç•°å¸¸ç‹€æ…‹æŠµæŠ—", percKey: null, icon: "ğŸ›¡ï¸", desc: "æŠµæŠ—æšˆçœ©ã€æ“Šå€’ç­‰ç‹€æ…‹ç•°å¸¸çš„èƒ½åŠ›ã€‚" },
                { title: "ç²¾ç¥åŠ›", baseKey: "ç²¾ç¥åŠ›", percKey: "ç²¾ç¥åŠ›å¢åŠ %", icon: "ğŸ”®", desc: "è§’è‰²çš„æœ€å¤§æ³•åŠ›è³‡æºã€‚" },
                { title: "ç§»å‹•é€Ÿåº¦", baseKey: "ç§»å‹•é€Ÿåº¦", percKey: "ç§»å‹•é€Ÿåº¦%", icon: "ğŸƒ", desc: "è§’è‰²çš„ç§»å‹•å¿«æ…¢ã€‚" },
                { title: "PVEæ”»æ“ŠåŠ›", baseKey: "PVEæ”»æ“ŠåŠ›", percKey: null, icon: "ğŸ‰", desc: "å°ä¸€èˆ¬æ€ªç‰©é€ æˆçš„é¡å¤–æ”»æ“ŠåŠ›ã€‚" },
                { title: "PVEé˜²ç¦¦åŠ›", baseKey: "PVEé˜²ç¦¦åŠ›", percKey: null, icon: "ğŸ›¡ï¸", desc: "å—åˆ°ä¸€èˆ¬æ€ªç‰©æ”»æ“Šæ™‚çš„é¡å¤–é˜²ç¦¦åŠ›ã€‚" },
                { title: "PVEå‚·å®³å¢å¹…", baseKey: "PVEå‚·å®³å¢å¹…", percKey: null, icon: "ğŸ”¥", desc: "å°ä¸€èˆ¬æ€ªç‰©é€ æˆçš„å‚·å®³é¡å¤–å¢å¹…ã€‚" },
                { title: "é¦–é ˜æ”»æ“ŠåŠ›", baseKey: "é¦–é ˜æ”»æ“ŠåŠ›", percKey: null, icon: "ğŸ‘¹", desc: "å°é¦–é ˜æ€ªç‰©é€ æˆçš„é¡å¤–æ”»æ“ŠåŠ›ã€‚" },
                { title: "é¦–é ˜é˜²ç¦¦åŠ›", baseKey: "é¦–é ˜é˜²ç¦¦åŠ›", percKey: null, icon: "ğŸ›¡ï¸", desc: "å—åˆ°é¦–é ˜æ€ªç‰©æ”»æ“Šæ™‚çš„é¡å¤–é˜²ç¦¦åŠ›ã€‚" },
                { title: "é¦–é ˜å‚·å®³å¢å¹…", baseKey: "é¦–é ˜å‚·å®³å¢å¹…", percKey: null, icon: "ğŸ’¥", desc: "å°é¦–é ˜æ€ªç‰©é€ æˆçš„å‚·å®³é¡å¤–å¢å¹…ã€‚" }
            ];

            let html = "";

            // ç¶œåˆè©•åˆ†å¡ç‰‡ (å¦‚æœæœ‰ API è³‡æ–™)
            if (data.rating && data.rating.scores) {
                const score = data.rating.scores.score;
                const model = data.rating.modelType || "PVE";
                const ver = data.rating.modelVersion || "1.2";
                html += `
                    <div class="stat-mini-card" style="grid-column: 1 / -1; background: linear-gradient(135deg, rgba(230, 185, 103, 0.15) 0%, rgba(255, 255, 255, 0.03) 100%); border: 1px solid rgba(230, 185, 103, 0.3); padding: 20px;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="text-align:left;">
                                <div style="font-size:14px; color:#8b949e;">ç¶œåˆæˆ°é¬¥è©•åˆ†</div>
                                <div style="font-size:36px; font-weight:bold; color:var(--gold); margin-top:5px;">${Math.round(score * 100) / 100}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:12px; color:#8b949e;">æ¨¡å‹é¡å‹: <span style="color:#fff;">${model}</span></div>
                                <div style="font-size:12px; color:#8b949e;">æ¨¡å‹ç‰ˆæœ¬: <span style="color:#fff;">${ver}</span></div>
                            </div>
                        </div>
                        <div style="font-size:12px; color:#636e7b; text-align:left; margin-top:10px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                            åŸºæ–¼ç›®å‰çš„è§’è‰²å±¬æ€§ã€è£å‚™çµ„åˆèˆ‡ç³»çµ±åŠ æˆè¨ˆç®—ä¹‹æœŸæœ›å€¼è©•åˆ†ã€‚
                        </div>
                    </div>
                `;
            }

            html += analysisItems.map(item => {
                const base = getStatObj(item.baseKey);
                const perc = item.percKey ? getStatObj(item.percKey) : { total: 0, s: null };

                // å˜—è©¦æŠ“å–å®˜æ–¹é¢æ¿æ•¸å€¼ (ä½œç‚ºçœŸå€¼åƒè€ƒ)
                const officialStat = (data.stat.statList || []).find(s => s.name === item.title || s.name === item.baseKey);

                let officialVal = 0;
                let hasOfficial = false;
                let isDisplayPercent = false;

                if (officialStat) {
                    const valStr = officialStat.value.toString();
                    officialVal = parseFloat(valStr.replace(/,/g, '').replace('%', ''));
                    if (valStr.includes('%')) isDisplayPercent = true;
                    hasOfficial = true;
                }

                // å¦‚æœå®˜æ–¹æ•¸å€¼æ²’æœ‰%ï¼Œå‰‡æª¢æŸ¥åŸºç¤å±¬æ€§å®šç¾©æ˜¯å¦ç‚ºç™¾åˆ†æ¯”
                if (!isDisplayPercent) {
                    if (item.baseKey.includes('%') || (base.s && base.s.isPerc)) {
                        isDisplayPercent = true;
                    }
                }

                // è¨ˆç®—ç›®å‰çš„è¨ˆç®—ç¸½å€¼ (ä¸å«ç™¾åˆ†æ¯”åŠ æˆå‰çš„åŸºç¤ç´¯åŠ ç‹€æ…‹)
                // é€™è£¡çš„ base.total æ˜¯æ‰€æœ‰ä¾†æº(è£å‚™ã€æ¿å¡Šç­‰)çš„å¹³ç›¤æ•¸å€¼ç¸½å’Œ
                const calculatedFlat = base.total;

                // è¨ˆç®—é æœŸæœ€çµ‚å€¼
                let estimated = calculatedFlat;
                if (item.percKey) {
                    estimated = calculatedFlat * (1 + (perc.total / 100));
                }

                // è¨ˆç®—æ­¤å±¬æ€§æ˜¯å¦å­˜åœ¨ (æœ‰å®˜æ–¹æ•¸å€¼ æˆ– æœ‰è¨ˆç®—æ•¸å€¼)
                if (calculatedFlat === 0 && perc.total === 0 && !hasOfficial) return "";

                let mainValueHtml = "";
                let subValueHtml = "";
                let formulaHtml = `<div style="margin-top:8px; padding-top:8px; border-top:1px solid rgba(255,255,255,0.1);">`;

                // ç”¢ç”Ÿè©³ç´°æ‹†è§£çš„è¼”åŠ©å‡½æ•¸
                const getBreakdown = (statObj, title) => {
                    if (!statObj.s) return "";
                    const s = statObj.s;
                    const isP = s.isPerc;
                    let bHtml = `<div style="margin-bottom:12px; background:rgba(255,255,255,0.03); border-radius:6px; padding:10px; border:1px solid rgba(255,255,255,0.05);">
                                    <b style="color:var(--gold); display:block; padding-bottom:6px; border-bottom:1px solid rgba(230, 185, 103, 0.2); margin-bottom:8px; font-size:14px;">ğŸ“ ${title} æ§‹æˆ:</b>`;

                    // 1. ä¸»è¦èƒ½åŠ›å€¼è½‰æ› (å·²åœç”¨ statSecondList è§£æå¾Œï¼Œé€™è£¡é€šå¸¸ç‚º 0ï¼Œé™¤éæœ‰å…¶ä»–ä¾†æº)
                    if (s.subtotals.mainStat !== 0) {
                        bHtml += `<div style="font-size:13px; color:#fff; font-weight:bold; margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ ä¸»è¦èƒ½åŠ›å€¼è½‰æ›:</span><span style="color:var(--blue);">+${fmt(s.subtotals.mainStat, isP)}</span></div>`;
                    }

                    // 2. å…­å¤§æ¿å¡ŠåŠ æˆ
                    const boardSum = s.nezakan + s.zikel + s.baizel + s.triniel + s.ariel + s.asphel;
                    if (boardSum !== 0) bHtml += `<div style="font-size:13px; color:#e0e0e0; margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ å…­å¤§æ¿å¡Š:</span><span>+${fmt(boardSum, isP)}</span></div>`;

                    // 3. è£å‚™åŠ æˆ
                    if (s.equipMain !== 0) bHtml += `<div style="font-size:13px; color:#e0e0e0; margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ æ­¦é˜²åŸºç¤/å¼·åŒ–:</span><span>+${fmt(s.equipMain, isP)}</span></div>`;
                    if (s.equipSub !== 0) bHtml += `<div style="font-size:13px; color:#e0e0e0; margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ éš¨æ©Ÿå±¬æ€§/ç£¨çŸ³:</span><span>+${fmt(s.equipSub, isP)}</span></div>`;

                    // 4. ç‰¹æ®Šç³»çµ±åŠ æˆ
                    if (s.subtotals.title !== 0) bHtml += `<div style="font-size:13px; color:var(--gold); margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ ğŸ–ï¸ ç¨±è™Ÿç³»çµ±:</span><span>+${fmt(s.subtotals.title, isP)}</span></div>`;
                    if (s.subtotals.arcana !== 0) bHtml += `<div style="font-size:13px; color:#58a6ff; margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ ğŸ´ é­”åŠ›è–ç‰©:</span><span>+${fmt(s.subtotals.arcana, isP)}</span></div>`;
                    if (s.subtotals.wing !== 0) bHtml += `<div style="font-size:13px; color:#3fb950; margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ ğŸª½ ç¿…è†€è£å‚™:</span><span>+${fmt(s.subtotals.wing, isP)}</span></div>`;
                    if (s.subtotals.wingHold !== 0) bHtml += `<div style="font-size:13px; color:#9d7cbf; margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ ğŸª½ ç¿…è†€æŒæœ‰:</span><span>+${fmt(s.subtotals.wingHold, isP)}</span></div>`;

                    // 5. å…¶ä»–é›œé …
                    const otherMisc = s.other - (s.subtotals.mainStat || 0) - (s.subtotals.wing || 0) - (s.subtotals.wingHold || 0) - (s.subtotals.arcana || 0) - (s.subtotals.title || 0);
                    if (Math.abs(otherMisc) > 0.01) {
                        bHtml += `<div style="font-size:13px; color:#8b949e; margin-top:4px; padding-top:4px; border-top:1px dashed rgba(255,255,255,0.1); display:flex; justify-content:space-between;"><span>â–¹ å…¶ä»–åŠ æˆ:</span><span>+${fmt(otherMisc, isP)}</span></div>`;
                    }

                    // 6. é¡¯ç¤ºè©²å±¬æ€§çš„å°è¨ˆ
                    const subtotal = (s.base || 0) + (s.equipMain || 0) + (s.equipSub || 0) + (s.other || 0) + boardSum;
                    bHtml += `<div style="font-size:14px; color:var(--gold); font-weight:bold; margin-top:8px; padding-top:8px; border-top:2px solid rgba(230, 185, 103, 0.3); display:flex; justify-content:space-between;"><span>ğŸ“Š ${title} å°è¨ˆ:</span><span>${fmt(subtotal, isP)}</span></div>`;

                    bHtml += `</div>`;
                    return bHtml;
                };

                // è™•ç†åŸºç¤å±¬æ€§å·®ç•° (Base/Passives)
                let baseDiff = 0;
                if (hasOfficial && !item.percKey) {
                    // å¦‚æœæ²’æœ‰ç™¾åˆ†æ¯”åŠ æˆï¼Œç›´æ¥æ¯”è¼ƒ
                    baseDiff = officialVal - calculatedFlat;
                } else if (hasOfficial && item.percKey) {
                    // å¦‚æœæœ‰ç™¾åˆ†æ¯”åŠ æˆï¼Œå›æ¨åŸºç¤å€¼å·®ç•°
                    // Official = (CalculatedBase + Diff) * (1 + Perc/100)
                    // Diff = (Official / (1 + Perc/100)) - CalculatedBase
                    const multiplier = 1 + (perc.total / 100);
                    const officialFlat = officialVal / multiplier;
                    baseDiff = officialFlat - calculatedFlat;
                }

                // æ¸²æŸ“ä¸»æ•¸å€¼é¡¯ç¤º (åŠ å…¥ isDisplayPercent åƒæ•¸)
                if (hasOfficial) {
                    mainValueHtml = `<div style="font-size:28px; font-weight:bold; color:var(--gold);">${fmt(officialVal, isDisplayPercent)}</div>`;
                } else {
                    mainValueHtml = `<div style="font-size:28px; font-weight:bold; color:var(--gold);">${fmt(estimated, isDisplayPercent)}</div>`;
                }

                // æ¢å¾©ç¶ è‰²è¨ˆç®—ä»‹é¢ (é¡¯ç¤ºåŸºç¤ x å€ç‡çš„å…¬å¼)
                if (item.percKey && base.total > 0 && perc.total > 0) {
                    formulaHtml += `<b style="color:var(--green); font-size:14px;">âˆ‘ åŠ æˆé‚è¼¯ (ä¹˜ç®—):</b><br>`;
                    formulaHtml += `<div style="font-size:14px; background:rgba(63,185,80,0.1); border-left:3px solid var(--green); padding:8px; margin:8px 0; font-family:monospace; color:#fff;">${fmt(base.total)} Ã— (1 + ${fmt(perc.total, true)}) = <span style="color:var(--green); font-weight:bold;">${fmt(estimated, isDisplayPercent)}</span></div>`;
                }

                // æ¸²æŸ“å…¬å¼èˆ‡å·®ç•° (å¦‚æœæœ‰å·®ç•°ï¼Œé¡¯ç¤ºè—è‰²æç¤ºæ¡†)
                if (Math.abs(baseDiff) > 1 && hasOfficial) {
                    // æœ‰å·®ç•°ï¼Œé¡¯ç¤ºç‚ºåŸºç¤/è¢«å‹•
                    formulaHtml += `<div style="font-size:13px; color:#c9d1d9; margin-bottom:10px; padding:8px; background:rgba(0,100,255,0.1); border-radius:4px; border-left:3px solid var(--blue);">
                        <b>â„¹ï¸ æ•¸å€¼æ ¡æ­£:</b><br>
                        ç³»çµ±åµæ¸¬åˆ°é¡å¤– <b>${fmt(baseDiff, isDisplayPercent)}</b> é»å±¬æ€§ã€‚<br>
                        <span style="font-size:11px; opacity:0.8;">(æ¨æ¸¬ç‚ºè§’è‰²åŸºç¤å€¼ã€è¢«å‹•æŠ€èƒ½æˆ–æœªçµ±è¨ˆä¾†æº)</span>
                    </div>`;

                    // å°‡å·®ç•°åŠ å› base ç”¨æ–¼å‚³çµ¦ getBreakdown é¡¯ç¤º (é›–ç„¶ getBreakdown åªé¡¯ç¤º s çš„å…§å®¹ï¼Œé€™è£¡æˆ‘å€‘æ‰‹å‹•è£œä¸€è¡Œ)
                    // é€™è£¡ä¸ä¿®æ”¹ base ç‰©ä»¶ï¼Œè€Œæ˜¯ç›´æ¥åœ¨ä¸‹æ–¹ formulaHtml è£œå……
                }

                formulaHtml += `<div style="margin-top:10px;"></div>`;

                // é¡¯ç¤º Breakdown
                let baseBreakdown = getBreakdown(base, item.baseKey);
                // ç‚ºäº†è®“ Breakdown å®Œæ•´ï¼Œå¦‚æœ baseDiff å­˜åœ¨ï¼Œæˆ‘å€‘ã€Œæ³¨å…¥ã€åˆ°é¡¯ç¤º HTML ä¸­
                if (Math.abs(baseDiff) > 1 && hasOfficial) {
                    // å°‹æ‰¾å°è¨ˆè¡Œä¸¦æ’å…¥ åŸºç¤å€¼
                    const insertPoint = baseBreakdown.lastIndexOf('<div style="font-size:14px;');
                    if (insertPoint !== -1) {
                        const addedRow = `<div style="font-size:13px; color:#fff; margin-bottom:4px; display:flex; justify-content:space-between;"><span>â–¹ è§’è‰²åŸºç¤/è¢«å‹•:</span><span>+${fmt(baseDiff, isDisplayPercent)}</span></div>`;
                        baseBreakdown = baseBreakdown.substring(0, insertPoint) + addedRow + baseBreakdown.substring(insertPoint);
                    }
                }
                formulaHtml += baseBreakdown;

                if (perc.total > 0) formulaHtml += getBreakdown(perc, item.percKey);
                formulaHtml += `</div>`;

                return `
                    <div class="stat-mini-card hover-calc" style="height:auto; min-height:110px; cursor:help; padding:15px; background:rgba(255,255,255,0.02); text-align:center;">
                        <div style="font-size:12px;color:#8b949e;display:flex;align-items:center;justify-content:center;gap:6px; margin-bottom:10px;">
                            ${item.icon} ${item.title}
                        </div>
                        ${mainValueHtml}
                        ${subValueHtml}
                        <div class="tooltip" style="bottom:100px; top:auto; width:300px; text-align:left; padding:15px; background:rgba(33, 39, 54, 0.98); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.15); box-shadow:0 10px 30px rgba(0,0,0,0.5);">
                            <button class="tooltip-close-btn" onclick="this.parentElement.classList.remove('tooltip-pinned'); event.stopPropagation();">âœ•</button>
                            <b style="color:var(--gold); border-bottom:2px solid var(--gold); display:block; margin-bottom:12px; font-size:16px; padding-bottom:4px;">ğŸ“Š ${item.title} æ·±åº¦åˆ†æ</b>
                            <div style="font-size:13px; color:#eee; margin-bottom:12px; line-height:1.6; background:rgba(255,255,255,0.03); padding:8px; border-radius:4px;">${item.desc}</div>
                            ${formulaHtml}
                            <div style="margin-top:12px; color:#8b949e; font-size:12px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; font-style:italic;">* ä»¥ä¸Šæ•¸æ“šç”±ç•¶å‰æ‰€æœ‰ç³»çµ±åŠ ç¸½å¾—å‡º</div>
                        </div>
                    </div>
                `;
            }).join('');

            grid.innerHTML = html;
        }

        function renderStatTable(stats) {
            // å®šç¾©å±¬æ€§åˆ†é¡èˆ‡é †åº
            const statOrder = {
                'åŸºæœ¬ç›¤': ['æ”»æ“ŠåŠ›', 'å‘½ä¸­', 'æš´æ“Š', 'ç”Ÿå‘½åŠ›', 'æˆ°é¬¥é€Ÿåº¦', 'é˜²ç¦¦åŠ›', 'è¿´é¿', 'æš´æ“ŠæŠµæŠ—', 'ç²¾ç¥åŠ›', 'ç§»å‹•é€Ÿåº¦'],
                'æˆ°é¬¥': ['è²«ç©¿', 'æš´æ“Šæ”»æ“ŠåŠ›', 'æš´æ“Šé˜²ç¦¦åŠ›', 'å¾Œæ–¹æ”»æ“ŠåŠ›', 'å¾Œæ–¹é˜²ç¦¦åŠ›', 'å‚·å®³å¢å¹…', 'å‚·å®³è€æ€§', 'æ­¦å™¨å‚·å®³å¢å¹…', 'æ­¦å™¨å‚·å®³è€æ€§', 'æš´æ“Šå‚·å®³å¢å¹…', 'æš´æ“Šå‚·å®³è€æ€§', 'å¾Œæ–¹å‚·å®³å¢å¹…', 'å¾Œæ–¹å‚·å®³è€æ€§', 'å°é­‚çŸ³é¡å¤–å‚·å®³'],
                'åˆ¤å®š': ['å¤šæ®µæ‰“æ“Šæ“Šä¸­', 'å¤šæ®µæ‰“æ“ŠæŠµæŠ—', 'å¾Œæ–¹æš´æ“Š', 'å¾Œæ–¹æš´æ“ŠæŠµæŠ—', 'æ ¼æ“‹è²«ç©¿', 'æ ¼æ“‹', 'éµå£è²«ç©¿', 'éµå£', 'å†ç”Ÿè²«ç©¿', 'å†ç”Ÿ', 'å®Œç¾', 'å®Œç¾æŠµæŠ—', 'å¼·æ“Š', 'å¼·æ“ŠæŠµæŠ—'],
                'PVP': ['PVPæ”»æ“ŠåŠ›', 'PVPé˜²ç¦¦åŠ›', 'PVPå‚·å®³å¢å¹…', 'PVPå‚·å®³è€æ€§', 'PVPå‘½ä¸­', 'PVPè¿´é¿', 'PVPæš´æ“Š', 'PVPæš´æ“ŠæŠµæŠ—'],
                'PVE': ['PVEæ”»æ“ŠåŠ›', 'PVEé˜²ç¦¦åŠ›', 'PVEå‘½ä¸­', 'PVEè¿´é¿', 'PVEå‚·å®³å¢å¹…', 'PVEå‚·å®³è€æ€§', 'é¦–é ˜æ”»æ“ŠåŠ›', 'é¦–é ˜å‚·å®³å¢å¹…', 'é¦–é ˜é˜²ç¦¦åŠ›', 'é¦–é ˜å‚·å®³è€æ€§'],
                'ç‰¹æ®Š': ['ç–¾èµ°é€Ÿåº¦', 'é£›è¡Œé€Ÿåº¦', 'æ²»ç™‚å¢å¹…', 'æ‰€å—åˆ¶æ²»ç™’é‡', 'å†·å»æ™‚é–“', 'åé¨ç–¾èµ°è¡Œå‹•åŠ›æ¶ˆè€—'],
                'è³‡æº': ['è¡Œå‹•åŠ›', 'é£›è¡ŒåŠ›', 'æˆ°é¬¥ç”Ÿå‘½åŠ›è‡ªç„¶æ¢å¾©', 'éæˆ°é¬¥ç”Ÿå‘½åŠ›è‡ªç„¶æ¢å¾©', 'ç”Ÿå‘½åŠ›è—¥æ°´æ¢å¾©', 'ç”Ÿå‘½åŠ›è—¥æ°´æ¢å¾©å¢åŠ ', 'æˆ°é¬¥ç²¾ç¥åŠ›è‡ªç„¶æ¢å¾©', 'éæˆ°é¬¥ç²¾ç¥åŠ›è‡ªç„¶æ¢å¾©', 'ç²¾ç¥åŠ›æ¶ˆè€—é‡', 'ç²¾ç¥åŠ›ç²å¾—å¢åŠ ', 'æˆ°é¬¥è¡Œå‹•åŠ›è‡ªç„¶æ¢å¾©', 'éæˆ°é¬¥è¡Œå‹•åŠ›è‡ªç„¶æ¢å¾©', 'æˆ°é¬¥é£›è¡ŒåŠ›è‡ªç„¶æ¢å¾©', 'éæˆ°é¬¥é£›è¡ŒåŠ›è‡ªç„¶æ¢å¾©']
            };

            // å»ºç«‹å±¬æ€§åˆ°åˆ†é¡çš„æ˜ å°„ (ç§»é™¤%å¾Œç²¾ç¢ºåŒ¹é…)
            const findCategory = (statName) => {
                // ç§»é™¤ % ç¬¦è™Ÿé€²è¡Œæ¯”å°
                const normalizedName = statName.replace(/%/g, '').trim();

                for (const [category, statList] of Object.entries(statOrder)) {
                    for (let i = 0; i < statList.length; i++) {
                        const definedName = statList[i].replace(/%/g, '').trim();
                        // ç²¾ç¢ºåŒ¹é…(ç§»é™¤%å¾Œå®Œå…¨ç›¸åŒ)
                        if (normalizedName === definedName) {
                            return { category, index: i };
                        }
                    }
                }
                return { category: 'å…¶ä»–', index: 999 };
            };

            // è‡ªè¨‚æ’åºå‡½æ•¸
            const sortedKeys = Object.keys(stats).sort((a, b) => {
                const resultA = findCategory(a);
                const resultB = findCategory(b);

                // å®šç¾©åˆ†é¡é †åº
                const categoryOrder = ['åŸºæœ¬ç›¤', 'æˆ°é¬¥', 'åˆ¤å®š', 'PVP', 'PVE', 'ç‰¹æ®Š', 'è³‡æº', 'å…¶ä»–'];
                const catIndexA = categoryOrder.indexOf(resultA.category);
                const catIndexB = categoryOrder.indexOf(resultB.category);

                // å…ˆæŒ‰åˆ†é¡æ’åº
                if (catIndexA !== catIndexB) {
                    return catIndexA - catIndexB;
                }

                // åŒåˆ†é¡å…§æŒ‰æŒ‡å®šé †åºæ’åº
                if (resultA.category !== 'å…¶ä»–') {
                    return resultA.index - resultB.index;
                }

                // å…¶ä»–åˆ†é¡æŒ‰å­—æ¯æ’åº
                return a.localeCompare(b, 'zh-TW');
            });

            let lastCategory = null;
            const categoryIcons = {
                'åŸºæœ¬ç›¤': 'âš”ï¸',
                'æˆ°é¬¥': 'ğŸ’¥',
                'åˆ¤å®š': 'ğŸ²',
                'PVP': 'âš¡',
                'PVE': 'ğŸ‰',
                'ç‰¹æ®Š': 'âœ¨',
                'è³‡æº': 'ğŸ’§',
                'å…¶ä»–': 'ğŸ“¦'
            };

            const categoryColors = {
                'åŸºæœ¬ç›¤': { bg: 'linear-gradient(90deg, rgba(99, 102, 241, 0.15) 0%, rgba(99, 102, 241, 0.05) 100%)', border: 'rgba(99, 102, 241, 0.5)', text: '#818cf8' },
                'æˆ°é¬¥': { bg: 'linear-gradient(90deg, rgba(239, 68, 68, 0.15) 0%, rgba(239, 68, 68, 0.05) 100%)', border: 'rgba(239, 68, 68, 0.5)', text: '#f87171' },
                'åˆ¤å®š': { bg: 'linear-gradient(90deg, rgba(168, 85, 247, 0.15) 0%, rgba(168, 85, 247, 0.05) 100%)', border: 'rgba(168, 85, 247, 0.5)', text: '#c084fc' },
                'PVP': { bg: 'linear-gradient(90deg, rgba(234, 179, 8, 0.15) 0%, rgba(234, 179, 8, 0.05) 100%)', border: 'rgba(234, 179, 8, 0.5)', text: '#fbbf24' },
                'PVE': { bg: 'linear-gradient(90deg, rgba(34, 197, 94, 0.15) 0%, rgba(34, 197, 94, 0.05) 100%)', border: 'rgba(34, 197, 94, 0.5)', text: '#4ade80' },
                'ç‰¹æ®Š': { bg: 'linear-gradient(90deg, rgba(236, 72, 153, 0.15) 0%, rgba(236, 72, 153, 0.05) 100%)', border: 'rgba(236, 72, 153, 0.5)', text: '#f472b6' },
                'è³‡æº': { bg: 'linear-gradient(90deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%)', border: 'rgba(6, 182, 212, 0.5)', text: '#22d3ee' },
                'å…¶ä»–': { bg: 'linear-gradient(90deg, rgba(148, 163, 184, 0.15) 0%, rgba(148, 163, 184, 0.05) 100%)', border: 'rgba(148, 163, 184, 0.5)', text: '#94a3b8' }
            };

            document.getElementById('stat-body').innerHTML = sortedKeys.map(k => {
                const d = stats[k];
                const sum = d.nezakan + d.zikel + d.baizel + d.triniel + d.ariel + d.asphel + d.equipMain + d.equipSub + d.other;
                if (sum === 0) return '';

                // æª¢æŸ¥æ˜¯å¦éœ€è¦æ’å…¥åˆ†é¡æ¨™é¡Œ
                const currentCategory = findCategory(k).category;
                let categoryHeader = '';
                if (currentCategory !== lastCategory) {
                    const icon = categoryIcons[currentCategory] || 'ğŸ“¦';
                    const colors = categoryColors[currentCategory] || categoryColors['å…¶ä»–'];
                    categoryHeader = `<tr class="category-header"><td colspan="11" style="background: ${colors.bg}; padding: 14px 20px; font-weight: bold; font-size: 14px; color: ${colors.text}; border-top: 2px solid ${colors.border}; border-bottom: 1px solid ${colors.border}; letter-spacing: 0.5px;">${icon} ${currentCategory}</td></tr>`;
                    lastCategory = currentCategory;
                }

                const fmt = (v) => v === 0 ? '--' : (Math.round(v * 100) / 100 + (d.isPerc ? '%' : ''));
                const makeGroup = (title, items, color, subtotal) => {
                    if (items.length === 0) return "";
                    let content = `<div style="margin-top:10px; background:rgba(255,255,255,0.02); padding:8px; border-radius:4px;"><b style="color:${color}; border-bottom:1px solid rgba(255,255,255,0.1); display:block; margin-bottom:6px; font-size:14px;">${title}</b>`;
                    content += items.map(i => `<div style="font-size:13px; color:#eee; padding-left:5px; margin-bottom:3px;">â–¹ ${i}</div>`).join('');
                    // æ·»åŠ å°è¨ˆ
                    if (subtotal !== undefined && subtotal !== 0) {
                        content += `<div style="font-size:13px; color:${color}; font-weight:bold; margin-top:6px; padding-left:5px; border-top:1px dashed rgba(255,255,255,0.2); padding-top:4px; display:flex; justify-content:space-between;"><span>å°è¨ˆ:</span><span>${fmt(subtotal)}</span></div>`;
                    }
                    content += `</div>`;
                    return content;
                };

                let tooltip = `<b style="font-size:14px; color:var(--gold); border-bottom:2px solid var(--gold); display:block; margin-bottom:5px;">${k} ä¾†æºå°å¸³è¡¨</b>`;

                // è¨ˆç®—æ¿å¡Šç¸½å’Œ
                const boardTotal = d.nezakan + d.zikel + d.baizel + d.triniel + d.ariel + d.asphel;
                if (boardTotal > 0) {
                    tooltip += `<div style="margin-top:10px; background:rgba(230, 185, 103, 0.05); padding:8px; border-radius:4px;"><b style="color:var(--gold); border-bottom:1px solid rgba(230, 185, 103, 0.2); display:block; margin-bottom:6px; font-size:14px;">ğŸ”± æ¿å¡ŠåŠ æˆ</b>`;
                    if (d.nezakan > 0) tooltip += `<div style="font-size:13px; color:#eee; padding-left:5px; display:flex; justify-content:space-between;"><span>â–¹ å¥ˆè–©è‚¯:</span><span>${fmt(d.nezakan)}</span></div>`;
                    if (d.zikel > 0) tooltip += `<div style="font-size:13px; color:#eee; padding-left:5px; display:flex; justify-content:space-between;"><span>â–¹ å‰å‡±çˆ¾:</span><span>${fmt(d.zikel)}</span></div>`;
                    if (d.baizel > 0) tooltip += `<div style="font-size:13px; color:#eee; padding-left:5px; display:flex; justify-content:space-between;"><span>â–¹ ç™½å‚‘çˆ¾:</span><span>${fmt(d.baizel)}</span></div>`;
                    if (d.triniel > 0) tooltip += `<div style="font-size:13px; color:#eee; padding-left:5px; display:flex; justify-content:space-between;"><span>â–¹ å´”å¦®çˆ¾:</span><span>${fmt(d.triniel)}</span></div>`;
                    if (d.ariel > 0) tooltip += `<div style="font-size:13px; color:#eee; padding-left:5px; display:flex; justify-content:space-between;"><span>â–¹ è‰¾ç‘çˆ¾:</span><span>${fmt(d.ariel)}</span></div>`;
                    if (d.asphel > 0) tooltip += `<div style="font-size:13px; color:#eee; padding-left:5px; display:flex; justify-content:space-between;"><span>â–¹ é˜¿æ–¯ä½©çˆ¾:</span><span>${fmt(d.asphel)}</span></div>`;
                    tooltip += `<div style="font-size:13px; color:var(--gold); font-weight:bold; margin-top:6px; padding-left:5px; border-top:1px dashed rgba(230, 185, 103, 0.2); padding-top:4px; display:flex; justify-content:space-between;"><span>å°è¨ˆ:</span><span>${fmt(boardTotal)}</span></div></div>`;
                }

                tooltip += makeGroup("ğŸ›¡ï¸ åŸºç¤å±¬æ€§èˆ‡å¼·åŒ–", d.detailGroups.base, "var(--blue)", d.equipMain);
                tooltip += makeGroup("ğŸ’ ç£¨çŸ³é‘²åµŒ", d.detailGroups.stone, "var(--gold)", d.subtotals.stone);
                tooltip += makeGroup("âœ¨ éš¨æ©Ÿåˆ»å°", d.detailGroups.random, "var(--green)", d.subtotals.random);
                tooltip += makeGroup("ğŸ–ï¸ ç¨±è™ŸåŠ æˆ", d.detailGroups.title, "var(--nezakan)", d.subtotals.title);
                tooltip += makeGroup("ğŸ“Š ä¸»è¦èƒ½åŠ›å€¼æ¦‚è¦½", d.detailGroups.mainStat || [], "var(--blue)", d.subtotals.mainStat);
                tooltip += makeGroup("ğŸª½ ç¿…è†€è£å‚™", d.detailGroups.wing || [], "var(--green)", d.subtotals.wing);
                tooltip += makeGroup("ğŸª½ ç¿…è†€æŒæœ‰", d.detailGroups.wingHold || [], "#9d7cbf", d.subtotals.wingHold);
                tooltip += makeGroup("ğŸ´ è–ç‰©/å…¶ä»–", d.detailGroups.arcana.concat(d.detailGroups.etc), "var(--arcana)", d.subtotals.arcana);
                const cell = (val) => val === 0 ? '<td>--</td>' : `<td><div class="hover-calc"><div class="tooltip" style="width:320px;"><button class="tooltip-close-btn" onclick="this.parentElement.classList.remove('tooltip-pinned'); event.stopPropagation();">âœ•</button>${tooltip}</div>${fmt(val)}</div></td>`;
                return categoryHeader + `<tr><td class="td-left">${k}</td><td>${fmt(d.nezakan)}</td><td>${fmt(d.zikel)}</td><td>${fmt(d.baizel)}</td><td>${fmt(d.triniel)}</td><td>${fmt(d.ariel)}</td><td>${fmt(d.asphel)}</td>${cell(d.equipMain)}${cell(d.equipSub)}${cell(d.other)}<td style="color:var(--green);font-weight:bold;">+${Math.round(sum * 100) / 100}${d.isPerc ? '%' : ''}</td></tr>`;
            }).join('');
        }



        // Tooltip é»æ“Šå›ºå®šåŠŸèƒ½
        document.addEventListener('DOMContentLoaded', function () {
            // ç‚ºæ‰€æœ‰ hover-calc å…ƒç´ æ·»åŠ é»æ“Šäº‹ä»¶
            document.addEventListener('click', function (e) {
                const hoverCalc = e.target.closest('.hover-calc');
                if (hoverCalc) {
                    const tooltip = hoverCalc.querySelector('.tooltip');
                    if (tooltip) {
                        // å¦‚æœé»æ“Šçš„ä¸æ˜¯é—œé–‰æŒ‰éˆ•,å‰‡åˆ‡æ›å›ºå®šç‹€æ…‹
                        if (!e.target.classList.contains('tooltip-close-btn')) {
                            // å…ˆé—œé–‰æ‰€æœ‰å…¶ä»–å›ºå®šçš„ tooltip
                            document.querySelectorAll('.tooltip.tooltip-pinned').forEach(t => {
                                if (t !== tooltip) {
                                    t.classList.remove('tooltip-pinned');
                                }
                            });
                            // åˆ‡æ›ç•¶å‰ tooltip çš„å›ºå®šç‹€æ…‹
                            tooltip.classList.toggle('tooltip-pinned');
                            e.stopPropagation();
                        }
                    }
                } else {
                    // é»æ“Šå…¶ä»–åœ°æ–¹æ™‚é—œé–‰æ‰€æœ‰å›ºå®šçš„ tooltip
                    if (!e.target.classList.contains('tooltip-close-btn')) {
                        document.querySelectorAll('.tooltip.tooltip-pinned').forEach(t => {
                            t.classList.remove('tooltip-pinned');
                        });
                    }
                }
            });

            // è¡¨é ­ tooltip å‹•æ…‹å®šä½ (ä½¿ç”¨ fixed å®šä½,é¡¯ç¤ºåœ¨è¡¨é ­ä¸‹æ–¹)
            document.addEventListener('mouseover', function (e) {
                const thHover = e.target.closest('thead th.th-hover');
                if (thHover) {
                    const tooltip = thHover.querySelector('.tooltip');
                    if (tooltip) {
                        const rect = thHover.getBoundingClientRect();
                        // é¡¯ç¤ºåœ¨è¡¨é ­ä¸‹æ–¹,å¢åŠ è¶³å¤ çš„é–“è·(ç´„ä¸€è¡Œè¡¨æ ¼çš„é«˜åº¦)é¿å…è¢«é®æ“‹
                        tooltip.style.top = (rect.bottom + 50) + 'px';
                        tooltip.style.left = (rect.left + rect.width / 2) + 'px';
                        tooltip.style.transform = 'translateX(-50%)';
                    }
                }
            });
        });
    </script>
</body>

</html>