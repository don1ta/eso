<!DOCTYPE html>
<html lang="zh-Hant-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>è§’è‰²å³æ™‚æŸ¥è©¢ç‰ˆ</title>
    <style>
        :root {
            --bg: #0b0e14;
            --panel: #1a1f29;
            --border: #333c4d;
            --gold: #d4b483;
            --blue: #58a6ff;
            --green: #3fb950;
            --nezakan: #e06c75;
            --zikel: #98c379;
            --triniel: #61afef;
            --ariel: #ff9f1c;
            --asphel: #bf40bf;
            --baizel: #ff6c6c;
            --arcana: #4ec9b0;
            --profile-bg: linear-gradient(135deg, #1e2533 0%, #0b0e14 100%);
        }
        body {
            background: var(--bg);
            color: #e6edf3;
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            margin: 0;
            padding: 15px;
            font-size: 15px;
        }
        .container { max-width: 1900px; margin: auto; }
        
        /* é‡æ–°è¨­è¨ˆè¼¸å…¥å€åŸŸï¼Œç¢ºä¿æ¸…æ™°å¯è¦‹ */
        .input-area {
            background: var(--panel);
            border: 2px solid var(--gold); /* åŠ ç²—é‚Šæ¡†æ–¹ä¾¿è¾¨è­˜ */
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            display: flex;
            flex-direction: column; /* æ”¹ç‚ºå‚ç›´æ’åˆ— */
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .input-row {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .input-group { display: flex; align-items: center; gap: 10px; }
        
        input, select {
            background: #010409;
            border: 1px solid var(--border);
            color: #fff;
            padding: 12px;
            border-radius: 6px;
            font-size: 15px;
            outline: none;
        }
        input:focus { border-color: var(--gold); background: #0d1117; }

        /* åç¨±æ¡†å¯¬åº¦ */
        #charName { width: 250px; }
        /* ç¶²å€æ¡†å¯¬åº¦ - è®“å®ƒéå¸¸é•· */
        #apiLink { width: 600px; border-color: var(--blue); }

        .or-divider {
            color: #8b949e;
            font-size: 14px;
            font-weight: bold;
            padding: 5px 0;
            border-top: 1px solid #333c4d;
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        .or-divider::after { content: ""; flex: 1; height: 1px; background: #333c4d; margin-left: 10px; }

        button {
            background: linear-gradient(135deg, #d4b483, #aa8a59);
            color: #000;
            border: none;
            padding: 12px 40px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: 0.2s;
        }
        button:hover { filter: brightness(1.1); transform: translateY(-1px); }

        /* ä»¥ä¸‹ç‚ºåŸæœ‰çš„å„€è¡¨æ¿ CSS */
        .dashboard { display: none; flex-direction: column; gap: 20px; }
        .profile-card { background: var(--profile-bg); border: 1px solid var(--gold); border-radius: 12px; padding: 25px; display: flex; align-items: center; gap: 30px; flex-wrap: wrap; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); }
        .profile-img { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--gold); padding: 3px; background: #000; }
        .profile-name { font-size: 32px; font-weight: 800; color: #fff; text-shadow: 0 0 10px rgba(212, 180, 131, 0.3); }
        .rank-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .rank-badge { background: rgba(255,255,255,0.05); border: 1px solid var(--border); border-radius: 8px; padding: 8px 12px; display: flex; align-items: center; gap: 10px; min-width: 160px; }
        .rank-badge img { width: 32px; height: 32px; }
        .rank-info { display: flex; flex-direction: column; }
        .rank-title { font-size: 14px; color: #f1eae8; }
        .rank-val { font-weight: bold; font-size: 14px; color: var(--gold); }
        .rank-change { font-size: 10px; margin-left: 5px; }
        .up { color: #ff6c6c; }
        .down { color: #3fb950; }
        .card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 25px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3); margin-bottom: 20px; position: relative; }
        h3 { color: var(--gold); margin: 0 0 15px 0; font-size: 19px; border-left: 5px solid var(--gold); padding-left: 12px; }
        .sk-label { font-size: 14px; color: #8b949e; margin-bottom: 12px; border-bottom: 1px solid #333c4d; padding-bottom: 5px; font-weight: bold; }
        .stat-grid-main { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 10px; }
        .stat-mini-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 10px; padding: 15px; text-align: center; position: relative; cursor: help; transition: all 0.2s; }
        .stat-mini-card:hover { background: rgba(88, 166, 255, 0.08); transform: translateY(-3px); z-index: 100; border-color: var(--blue); }
        .stat-mini-val { display: block; font-size: 22px; font-weight: bold; color: var(--gold); margin-top: 5px; }
        .main-layout-wrapper { display: grid; grid-template-columns: 4fr 6fr; gap: 20px; align-items: flex-start; }
        .skill-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-bottom: 25px; }
        .skill-card { position: relative; display: flex; align-items: center; gap: 8px; padding: 10px; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border); border-radius: 8px; cursor: help; transition: 0.2s; }
        .skill-card img { width: 34px; height: 34px; border-radius: 4px; border: 1px solid var(--gold); }
        .sk-name { font-size: 13px; font-weight: bold; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85px; }
        .tooltip { visibility: hidden; width: 220px; background: #4c4d49 !important; border: 1px solid var(--gold); border-radius: 8px; padding: 12px; position: absolute; z-index: 9999 !important; bottom: 115%; left: 60%; transform: translateX(-50%); opacity: 0; transition: opacity 0.15s; box-shadow: 0 10px 40px rgb(0, 0, 0); color: #ffffff !important; pointer-events: none; white-space: normal; font-size: 12px; line-height: 1.5; border-top: 3px solid var(--gold); }
        .th-hover, .hover-calc, .skill-card, .stat-mini-card { position: relative; }
        .th-hover:hover .tooltip, .hover-calc:hover .tooltip, .skill-card:hover .tooltip, .stat-mini-card:hover .tooltip { visibility: visible; opacity: 1; bottom: 165%; }
        .table-wrapper { overflow: visible !important; }
        table { border-collapse: separate; border-spacing: 0; font-size: 14px; width: 100%; white-space: nowrap; }
        thead th { position: sticky; top: 0; background: #212631; z-index: 10; padding: 12px 5px; border-bottom: 2px solid var(--gold); border-right: 1px solid var(--border); }
        td { border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); padding: 10px 5px; text-align: center; }
        .td-left { text-align: left !important; font-weight: bold; color: #fff; padding-left: 15px; position: sticky; left: 0; background: #1a1f29; z-index: 5; min-width: 140px; }
        .hover-calc { border-bottom: 1px dashed var(--blue); cursor: help; display: inline-block; }
        .grid-box-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .info-box { background: rgba(212, 180, 131, 0.05); border: 1px solid var(--gold); border-radius: 8px; padding: 15px; }
        .box-header { border-bottom: 1px solid var(--border); padding-bottom: 5px; margin-bottom: 8px; font-weight: bold; color: var(--gold); font-size: 14px; }
        .title-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 15px; }
        .title-box { background: rgba(88, 166, 255, 0.08); border: 1px solid var(--blue); border-radius: 8px; padding: 12px; }
        .title-label { font-size: 11px; color: var(--blue); display: block; border-bottom: 1px solid rgba(88, 166, 255, 0.2); margin-bottom: 5px; padding-bottom: 3px; }
        .title-val { font-size: 15px; font-weight: bold; color: #fff; display: block; margin-bottom: 5px; }
        .title-desc { font-size: 12px; color: #aaa; line-height: 1.4; }
        .section-header { display: flex; align-items: center; gap: 10px; margin: 25px 0 15px 0; color: var(--gold); font-size: 1.3em; border-bottom: 1px solid var(--border); padding-bottom: 8px; font-weight: bold; }
        #equip-armor-list, #equip-accessory-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); gap: 12px; }
        .equip-item-card { background: rgba(255, 255, 255, 0.03); border: 1px solid var(--border); border-radius: 8px; display: flex; min-height: 120px; border-top: 3px solid var(--gold); transition: 0.2s; }
        .equip-left-section { flex: 1.3; padding: 12px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid rgba(255, 255, 255, 0.05); }
        .equip-right-section { flex: 1; background: rgba(0, 0, 0, 0.2); padding: 12px; font-size: 12px; }
        .equip-img-container { position: relative; width: 44px; height: 44px; flex-shrink: 0; }
        .equip-img-container img { width: 44px; height: 44px; border-radius: 4px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .exceed-badge { position: absolute; top: -7px; right: -7px; background: #ff3e3e; color: white; border: 1px solid #ffd700; font-size: 10px; padding: 1px 4px; border-radius: 4px; font-weight: bold; box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); z-index: 2; }
        .equip-name { font-weight: bold; font-size: 14px; line-height: 1.2; display: block; }
        .base-stat-row { border-bottom: 1px solid rgba(255, 255, 255, 0.05); padding: 3px 0; font-size: 12px; }
        .random-row { display: flex; justify-content: space-between; color: var(--green); margin-bottom: 3px; }
        .skill-badge-mini { color: var(--blue); margin-top: 5px; display: block; font-weight: bold; border-left: 2px solid var(--blue); padding-left: 6px; font-size: 11px; }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="input-area">
            <div class="input-row">
                <div class="input-group">
                    <label style="color:var(--gold); font-weight:bold;">ğŸ” è§’è‰²åç¨±ï¼š</label>
                    <input type="text" id="charName" placeholder="è«‹è¼¸å…¥åç¨±">
                </div>
                <div class="input-group">
                    <label>ä¼ºæœå™¨ï¼š</label>
                    <select id="serverSelect">
                        <optgroup label="â”€â”€â”€ å¤©æ— (Race 1) â”€â”€â”€">
                            <option value="å°¤æ–¯è¿ªåŸƒ">å°¤æ–¯</option> <option value="å¸ŒåŸƒçˆ¾">å¸ŒåŸƒ</option>
                            <option value="å¥ˆè–©è‚¯">å¥ˆè–©</option> <option value="ç™½å‚‘çˆ¾">ç™½å‚‘</option>
                            <option value="å‡±è¥¿å…§çˆ¾">å‡±è¥¿</option> <option value="è‰¾ç‘çˆ¾">è‰¾ç‘</option>
                            <option value="æ™®é›·å¥‡ç¿">æ™®é›·</option> <option value="æ¢…æ–¯è˜­æ³°é”">æ¢…æ–¯</option>
                            <option value="å¸Œå¡”å°¼è€¶">å¸Œå¡”</option> <option value="ç´å°¼äº">ç´å°¼</option>
                            <option value="å¡”å“ˆå·´é”">å¡”å“ˆ</option> <option value="è·¯ç‰¹æ–¯">è·¯ç‰¹</option>
                            <option value="è²çˆ¾è«¾æ–¯">è²çˆ¾</option> <option value="é”å½ŒåŠª">é”å½Œ</option>
                            <option value="å¡è–©å¡">å¡è–©</option> <option value="å·´å¡çˆ¾æ‘©">å·´å¡</option>
                            <option value="å¤©åŠ éš†">å¤©åŠ </option> <option value="ç§‘å¥‡éš†">ç§‘å¥‡</option>
                        </optgroup>
                        <optgroup label="â”€â”€â”€ é­”æ— (Race 2) â”€â”€â”€">
                            <option value="ä¼Šæ–¯æ‹‰ä½©çˆ¾">ä¼Šæ–¯</option> <option value="å‰å‡±çˆ¾">å‰å‡±</option>
                            <option value="å´”å¦®çˆ¾">å´”å¦®</option> <option value="éœ²æ¢…çˆ¾">éœ²æ¢…</option>
                            <option value="ç‘ªçˆ¾åº«å¦">ç‘ªçˆ¾</option> <option value="é˜¿æ–¯ä½©çˆ¾">é˜¿æ–¯</option>
                            <option value="è‰¾èŠä¿®å¥‡å¡">è‰¾èŠ</option> <option value="å¸ƒé‡Œç‰¹æ‹‰">å¸ƒé‡Œ</option>
                            <option value="å¥ˆè’™">å¥ˆè’™</option> <option value="å“ˆé”çˆ¾">å“ˆé”</option>
                            <option value="ç›§å¾·èŠ">ç›§å¾·</option> <option value="é„”çˆ¾å¤å€«">é„”çˆ¾</option>
                            <option value="é»˜å°¼">é»˜å°¼</option> <option value="å¥§é”çˆ¾">å¥§é”</option>
                            <option value="ç°¡å¡å¡">ç°¡å¡</option> <option value="å…‹ç¾…æ¢…å¾·">å…‹ç¾…</option>
                            <option value="å¥éˆ">å¥éˆ</option> <option value="å·´å·´éš†">å·´å·´</option>
                        </optgroup>
                    </select>
                    
                </div>
                <button id="searchBtn" onclick="fetchAndProcess()">é–‹å§‹æŸ¥è©¢è§’è‰²æ•¸æ“š</button>
            </div>

            <div class="or-divider">è‹¥æŸ¥ä¸åˆ°è«‹åœ¨ä¸‹æ–¹ç›´æ¥è²¼ä¸Šç¶²å€</div>

            <div class="input-row">
                <div class="input-group">
                    <label style="color:var(--blue); font-weight:bold;">ğŸ”— å®˜æ–¹APIé€£çµï¼š</label>
                    <input type="text" id="apiLink" placeholder="ç¶²å€">
                </div>
                
                æœ¬ç¶²ç«™åƒ…ä¾›å€‹äººå°ˆæ¡ˆç·´ç¿’ä½¿ç”¨ï¼Œä¸æä¾›å•†æ¥­ç”¨é€”ï¼Œè«‹å‹¿ç”¨æ–¼ç‡Ÿåˆ©è¡Œç‚ºï¼Œè³‡æ–™ä¾†æºçš†ä¾†è‡ªå®˜æ–¹APIï¼Œè‹¥æœ‰ä¸æ­£ç¢ºè«‹ä»¥å®˜æ–¹è³‡æ–™ç‚ºä¸»ã€‚
                <span id="loadingTxt" style="display:none; color:var(--gold); font-weight:bold;">æŠ“å–ä¸­...</span>
            </div>
        </div>

        <div id="main-content" class="dashboard">
            <div class="profile-card">
                <img id="p-img" class="profile-img" src="">
                <div style="flex:1">
                    <span id="p-name" class="profile-name"></span>
                    <span id="p-title-disp" style="color:var(--blue); margin-left:15px; font-weight:bold;"></span>
                    <div style="display:flex; flex-wrap:wrap; gap:20px; margin-top:10px; color:#8b949e">
                        <span>ä¼ºæœå™¨ï¼š<b id="p-server" style="color:var(--gold)"></b></span>
                        <span>ç­‰ç´šï¼š<b id="p-lv" style="color:var(--gold)"></b></span>
                        <span>è·æ¥­ï¼š<b id="p-class" style="color:var(--gold)"></b></span>
                        <span>é“å…·ç­‰ç´šï¼š<b id="p-itemlv" style="color:#58a6ff"></b></span>
                        <span>æœ€å¾Œæ›´æ–°ï¼š<b id="p-update" style="color:#3fb950"></b></span>
                    </div>
                    <div id="p-ranking-container" class="rank-container"></div>
                </div>
            </div>

            <div class="main-layout-wrapper">
                <div class="left-column">
                    <div class="card">
                        <h3>ğŸ“Š ä¸»è¦èƒ½åŠ›å€¼å°å¸³æ¦‚è¦½</h3>
                        <div id="stat-main-grid" class="stat-grid-main"></div>
                        <h4 style="color:#8b949e; margin-top:10px; font-size:12px;">** æ­¤å€å¡Šå®˜æ–¹ä¸¦æ²’æœ‰å° API åšå³æ™‚æ›´æ–° **</h4>
                    </div>
                    <div class="card">
                        <h3>âš”ï¸ æŠ€èƒ½ç­‰ç´šåˆ†è§£</h3>
                        <div class="sk-label">â–¶ ä¸»å‹•æŠ€èƒ½</div><div id="sk-act" class="skill-list"></div>
                        <div class="sk-label">â–¶ è¢«å‹•æŠ€èƒ½</div><div id="sk-pas" class="skill-list"></div>
                        <div class="sk-label">â–¶ ç‰¹æ®Š/çƒ™å°æŠ€èƒ½</div><div id="sk-stigma" class="skill-list"></div>
                    </div>
                    <div class="card">
                        <h3>ğŸ´ é­”åŠ›è–ç‰©ç³»çµ±ç´°é …</h3>
                        <div id="arcana-grid" class="grid-box-container"></div>
                        <h3>ğŸ”± å¥—è£æ•ˆæœå…¨è¦½</h3>
                        <div id="set-bonus-grid" class="grid-box-container" style="grid-template-columns: 1fr;"></div>
                        <h3>ğŸ–ï¸ ç¨±è™Ÿç³»çµ±åŠ æˆç´°é …</h3>
                        <div id="title-grid" class="title-grid"></div>
                    </div>
                </div>
                <div class="right-column">
                    <div class="card" style="padding:0">
                        <h3 style="padding: 25px 25px 0 25px;">ğŸ›¡ï¸ å±¬æ€§å…¨ä¾†æºå°å¸³ç¸½è¡¨</h3>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th class="td-left">å±¬æ€§é …ç›®</th>
                                        <th style="color:var(--nezakan)">å¥ˆè–©è‚¯</th>
                                        <th style="color:var(--zikel)">å‰å‡±çˆ¾</th>
                                        <th style="color:var(--baizel)">ç™½å‚‘çˆ¾</th>
                                        <th style="color:var(--triniel)">å´”å¦®çˆ¾</th>
                                        <th style="color:var(--ariel)">è‰¾ç‘çˆ¾</th>
                                        <th style="color:var(--asphel)">é˜¿æ–¯ä½©çˆ¾</th>
                                        <th style="color:var(--gold)">æ­¦é˜²å¼·åŒ–</th>
                                        <th style="color:var(--blue)">åˆ»å°</th>
                                        <th>å…¶ä»–/è–ç‰©</th>
                                        <th style="color:var(--green)">æœ€çµ‚åŠ ç¸½</th>
                                    </tr>
                                </thead>
                                <tbody id="stat-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="section-header">ğŸ›¡ï¸ æ­¦å™¨èˆ‡é˜²å…· (å¼·åŒ–/çªç ´ç´°ç¯€)</div>
                <div id="equip-armor-list"></div>
                <div class="section-header">ğŸ’ é£¾å“èˆ‡é…ä»¶ (å¼·åŒ–/çªç ´ç´°ç¯€)</div>
                <div id="equip-accessory-list"></div>
            </div>
        </div>
    </div>

<script>
    // --- API è«‹æ±‚æ ¸å¿ƒé‚è¼¯ ---
// --- ä¿®æ”¹å¾Œçš„ API è«‹æ±‚æ ¸å¿ƒé‚è¼¯ ---
async function fetchAndProcess() {
    const name = document.getElementById('charName').value.trim();
    const server = document.getElementById('serverSelect').value;
    const apiLinkInput = document.getElementById('apiLink').value.trim(); // ç²å–ç¶²å€è¼¸å…¥æ¡†
    const btn = document.getElementById('searchBtn');
    const loading = document.getElementById('loadingTxt');

    let apiUrl = "";

    // å„ªå…ˆæ¬Šåˆ¤æ–·ï¼šå¦‚æœã€Œå®˜æ–¹APIé€£çµã€æœ‰å¡«å¯«ï¼Œå„ªå…ˆä½¿ç”¨é€£çµ
    if (apiLinkInput) {
        apiUrl = apiLinkInput;
    } else if (name) {
        // å¦‚æœæ²’å¡«é€£çµä½†æœ‰å¡«åå­—ï¼Œå‰‡çµ„è£ç¶²å€
        apiUrl = `https://aion-api.bnshive.com/character/query?name=${encodeURIComponent(name)}&server=${server}`;
    } else {
        alert("è«‹è¼¸å…¥è§’è‰²åç¨±æˆ–ç›´æ¥è²¼ä¸Š API ç¶²å€ï¼");
        return;
    }

    btn.disabled = true;
    loading.style.display = "inline";
    
    try {
        const response = await fetch(apiUrl);
        if (!response.ok) throw new Error("API è«‹æ±‚å¤±æ•—");
        const json = await response.json();
        
        // é©—è­‰æ•¸æ“šæ˜¯å¦å­˜åœ¨
        if (!json.data && (!json.queryResult || !json.queryResult.data)) {
            alert("æ‰¾ä¸åˆ°è©²è§’è‰²ï¼Œè«‹ç¢ºèªç¶²å€ã€åç¨±æˆ–ä¼ºæœå™¨æ˜¯å¦æ­£ç¢ºã€‚");
            return;
        }

        processData(json);
    } catch (error) {
        console.error(error);
        alert("æŠ“å–æ•¸æ“šå‡ºéŒ¯ï¼\n1. è«‹æª¢æŸ¥ç¶²å€æ˜¯å¦æ­£ç¢º\n2. å¯èƒ½æ˜¯ç€è¦½å™¨è·¨ç¶²åŸŸ(CORS)é™åˆ¶\n3. ä¼ºæœå™¨æš«æ™‚ç„¡æ³•é€£ç·š");
    } finally {
        btn.disabled = false;
        loading.style.display = "none";
    }
}

    // --- ä»¥ä¸‹ç‚ºè§£æèˆ‡æ¸²æŸ“é‚è¼¯ (èˆ‡ä½ æä¾›çš„é‚è¼¯ä¸€è‡´) ---
    function getCorrectIcon(path) {
        if (!path) return "";
        if (path.startsWith('http')) return path;
        let cleanPath = path.replace(/^\//, '');
        if (!cleanPath.includes('.')) cleanPath += '.png';
        if (!cleanPath.includes('/')) cleanPath = `ui/icon/${cleanPath}`;
        return `https://assets.playnccdn.com/static-aion2-gamedata/resources/${cleanPath}`;
    }

    function getGradeColor(grade) {
        const colors = { 'Myth': '#ff3e3e', 'Unique': '#f90', 'Legend': '#d4b483', 'Epic': '#a335ee', 'Rare': '#0070dd', 'Ancient': '#3fb950' };
        return colors[grade] || 'white';
    }

    function processData(json) {
        const data = json.queryResult ? json.queryResult.data : json.data;
        document.getElementById('main-content').style.display = 'flex';

        // é‡ç½®å®¹å™¨
        document.getElementById('arcana-grid').innerHTML = "";
        document.getElementById('set-bonus-grid').innerHTML = "";
        document.getElementById('stat-body').innerHTML = "";

        // 1. åŸºæœ¬è³‡æ–™
        document.getElementById('p-name').innerText = data.profile.characterName;
        document.getElementById('p-title-disp').innerText = `[${data.profile.titleName || "ç„¡ç¨±è™Ÿ"}]`;
        document.getElementById('p-img').src = getCorrectIcon(data.profile.profileImage);
        document.getElementById('p-server').innerText = data.profile.serverName;
        document.getElementById('p-lv').innerText = `Lv.${data.profile.characterLevel}`;
        document.getElementById('p-class').innerText = data.profile.className;
        const itemLvObj = data.stat.statList.find(s => s.type === "ItemLevel");
        document.getElementById('p-itemlv').innerText = itemLvObj ? itemLvObj.value : "--";
        document.getElementById('p-update').innerText = new Date().toLocaleString('zh-TW', { hour12: false });

        renderRankings(data.ranking ? data.ranking.rankingList : []);

        let stats = {};
        let boardSkillMap = {};
        let cardSkillMap = {};
        let processedSets = new Set();
        let armorHtml = "";
        let accessoryHtml = "";
        let titleHtml = "";

        const getEntry = (k) => {
            if (!stats[k]) {
                stats[k] = { 
                    nezakan: 0, zikel: 0, baizel: 0, triniel: 0, ariel: 0, asphel: 0, 
                    equipMain: 0, equipSub: 0, other: 0, 
                    isPerc: k.includes('%'),
                    detailGroups: { base: [], random: [], stone: [], arcana: [], title: [], etc: [] }
                };
            }
            return stats[k];
        };

        // 2. èƒ½åŠ›å€¼æ¦‚è¦½
        let mainStatHtml = "";
        (data.stat.statList || []).forEach(s => {
            if (s.type === "ItemLevel") return;
            let details = s.statSecondList ? s.statSecondList.map(d => `â–¹ ${d}`).join('<br>') : "ç„¡é¡å¤–æ•¸æ“š";
            mainStatHtml += `<div class="stat-mini-card"><span style="font-size:12px;color:#8b949e;display:block;">${s.name}</span><span class="stat-mini-val">${s.value}</span><div class="tooltip"><b>${s.name} è©³ç´°è½‰æ›:</b><br>${details}</div></div>`;
        });
        document.getElementById('stat-main-grid').innerHTML = mainStatHtml;

        // 3. æ¿å¡Š
        if (data.daevanionBoardList) {
            data.daevanionBoardList.forEach(b => {
                const tipEl = document.getElementById(`tip-${b.name}`);
                if (tipEl) tipEl.innerHTML = `<b>${b.name} æ¿å¡Šå®Œæˆåº¦:</b><br>ç¯€é»ï¼š${b.openNodeCount}/${b.totalNodeCount}<br>é€²åº¦ï¼š${Math.round((b.openNodeCount / b.totalNodeCount) * 100)}%`;
            });
        }
        (data.daevanionDetails || []).forEach(b => {
            (b.detail?.openStatEffectList || []).forEach(ef => {
                let [n, vS] = ef.desc.split(' +'); if (!vS) return;
                let k = vS.includes('%') ? n.trim() + '%' : n.trim(), v = parseFloat(vS.replace('%', '')), e = getEntry(k);
                if (b.boardName.includes("å¥ˆè–©è‚¯")) e.nezakan += v;
                else if (b.boardName.includes("å‰å‡±çˆ¾")) e.zikel += v;
                else if (b.boardName.includes("ç™½å‚‘çˆ¾")) e.baizel += v;
                else if (b.boardName.includes("å´”å¦®çˆ¾")) e.triniel += v;
                else if (b.boardName.includes("è‰¾ç‘çˆ¾")) e.ariel += v;
                else if (b.boardName.includes("é˜¿æ–¯ä½©çˆ¾")) e.asphel += v;
            });
            (b.detail?.openSkillEffectList || []).forEach(sk => {
                let [sn, sv] = sk.desc.split(' +');
                boardSkillMap[sn] = (boardSkillMap[sn] || 0) + parseInt(sv);
            });
        });

        // 4. ç¨±è™Ÿ
        (data.title?.titleList || []).forEach(t => {
            if (t.equipCategory) { 
                let catName = t.equipCategory === "Attack" ? "âš”ï¸ æ”»æ“Šç¨±è™Ÿ" : "ğŸ›¡ï¸ é˜²ç¦¦ç¨±è™Ÿ";
                titleHtml += `<div class="title-box"><span class="title-label" style="color:${t.equipCategory === "Attack" ? 'var(--nezakan)' : 'var(--triniel)'}">${catName}</span><span class="title-val">${t.name}</span><div class="title-desc">${(t.equipStatList || []).map(ef => `â–¹ ${ef.desc}`).join('<br>')}</div></div>`;
                (t.equipStatList || []).forEach(ef => {
                    let [n, vS] = ef.desc.split(' +'); if (!vS) return;
                    let k = vS.includes('%') ? n.trim() + '%' : n.trim(), v = parseFloat(vS.replace('%', '')), e = getEntry(k);
                    e.other += v; e.detailGroups.title.push(`[${t.name}]: +${vS}`);
                });
            }
        });
        document.getElementById('title-grid').innerHTML = titleHtml || "<div style='color:#8b949e; padding:10px;'>æœªè£å‚™ç¨±è™Ÿ</div>";

        // 5. è£å‚™
        const equipMap = {};
        (data.equipment ? data.equipment.equipmentList : []).forEach(item => { equipMap[item.slotPos] = item; });
        (data.itemDetails || []).forEach(i => {
            const d = i.detail; if (!d) return;
            const slot = i.slotPos;
            const isArmor = (slot >= 1 && slot <= 8) || slot === 21;
            const isAccessory = (slot >= 9 && slot <= 20) || (slot >= 22 && slot <= 40);
            const isArcana = (slot >= 41 && slot <= 45);
            const originalItem = equipMap[slot] || i;
            const finalIcon = getCorrectIcon(originalItem.icon);

            if (d.set && !processedSets.has(d.set.name)) {
                processedSets.add(d.set.name);
                document.getElementById('set-bonus-grid').innerHTML += `<div class="info-box"><div class="box-header">ğŸ”± å¥—è£ï¼š${d.set.name}</div>${d.set.bonuses.map(b => `<div style="margin-bottom:8px; padding-left:10px; border-left:2px solid var(--blue)"><span style="color:var(--blue); font-weight:bold;">[${b.degree}ä»¶æ•ˆæœ]</span><br><span style="color:#e6edf3; font-size:12px;">${b.descriptions.join('ã€')}</span></div>`).join('')}</div>`;
            }

            if (isArcana) {
                const gradeColor = getGradeColor(d.grade); 
                const arcanaIcon = getCorrectIcon(originalItem.icon);
                let arcanaStatsHtml = (d.mainStats || []).map(ms => `<div>${ms.name} +${ms.value}</div>`).join('');
                let arcanaSubStatsHtml = (d.subStats || []).map(ss => `<div style="color:var(--green)">åˆ»å°: ${ss.name} +${ss.value}</div>`).join('');
                let arcanaSkillsHtml = (d.subSkills || []).map(sk => `<div style="color:var(--blue)">${sk.name} Lv.${sk.level}</div>`).join('');
                document.getElementById('arcana-grid').innerHTML += `<div class="info-box" style="border-left: 4px solid ${gradeColor}; border-top-color: ${gradeColor}; display: flex; gap: 10px; align-items: flex-start;"><div class="arcana-icon-wrapper"><img src="${arcanaIcon}" style="width: 44px; height: 44px; border: 1px solid ${gradeColor}; border-radius: 4px; background: #161b22; padding: 2px;"></div><div style="flex-grow: 1;"><div class="box-header" style="color:${gradeColor}; font-size: 13px; margin-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 3px;">+${i.enchantLevel} ${d.name}</div><div style="font-size:12px; margin-bottom:4px; color: #e6edf3;">${arcanaStatsHtml}</div><div style="font-size:11px; margin-bottom:4px;">${arcanaSubStatsHtml}</div><div style="font-size:11px;">${arcanaSkillsHtml}</div></div></div>`;
                (d.subSkills || []).forEach(sk => { if (!cardSkillMap[sk.name]) cardSkillMap[sk.name] = []; cardSkillMap[sk.name].push({ name: d.name, lv: sk.level }); });
                (d.mainStats || []).forEach(ms => { let e = getEntry(ms.name); e.other += parseFloat(ms.value); e.detailGroups.arcana.push(`${d.name}(ä¸»å±¬): +${ms.value}`); });
                (d.subStats || []).forEach(ss => { let k = ss.value.includes('%') ? ss.name + '%' : ss.name; let e = getEntry(k); e.other += parseFloat(ss.value.replace('%','')); e.detailGroups.arcana.push(`${d.name}(åˆ»å°): +${ss.value}`); });
            }

            if (isArmor || isAccessory) {
                let gradeColor = getGradeColor(d.grade);
                let exceedBadge = (originalItem.exceedLevel || 0) > 0 ? `<div class="exceed-badge">${originalItem.exceedLevel}</div>` : "";
                let mainStatsD = (d.mainStats || []).map(s => `<div class="base-stat-row"><b>${s.name} ${(parseFloat(s.value)||0)+(parseFloat(s.extra)||0)}</b>${(parseFloat(s.extra)>0)?` <span style="color:var(--green);">(+${s.extra})</span>`:""}</div>`).join('');
                let godStoneHtml = (d.godStoneStat || []).map(gs => `<div style="margin-top: 8px; padding: 8px; background: rgba(0, 212, 255, 0.05); border: 1px dashed rgba(0, 212, 255, 0.3); border-radius: 4px;"><div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;"><img src="${gs.icon}" style="width: 20px; height: 20px; border: 1px solid #00d4ff; border-radius: 3px;"><b style="color: #00d4ff; font-size: 12px;">${gs.name}</b></div><div style="color: #e6edf3; font-size: 11px; line-height: 1.4; padding-left: 2px;">${gs.desc ? gs.desc.replace(/\n/g, '<br>') : ""}</div></div>`).join('');
                let cardHtml = `<div class="equip-item-card" style="border-top-color: ${gradeColor}; border-left: 4px solid ${gradeColor};"><div class="equip-left-section"><div style="display:flex; align-items:center; gap:10px;"><div class="equip-img-container"><img src="${finalIcon}">${exceedBadge}</div><div><span class="equip-name" style="color:${gradeColor}">${d.name}</span><div><span style="color:#fff; font-weight:bold;">+${i.enchantLevel}</span></div></div></div><div style="margin-top:8px;">${mainStatsD}</div></div><div class="equip-right-section"><div style="color:#8b949e; font-size:10px; border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:5px;">åˆ»å°/ç¥çŸ³/ç£¨çŸ³</div>${(d.subStats||[]).map(s=>`<div class="random-row"><span>${s.name}</span><span>+${s.value}</span></div>`).join('')}${(d.subSkills||[]).map(sk=>`<div class="skill-badge-mini">${sk.name} Lv.${sk.level}</div>`).join('')}${godStoneHtml}<div style="margin-top:5px;">${(d.magicStoneStat||[]).map(ms=>`<div class="random-row" style="color:var(--gold); font-size:11px;"><span>[ç£¨çŸ³] ${ms.name}</span><span>${ms.value}</span></div>`).join('')}</div></div></div>`;
                if (isArmor) armorHtml += cardHtml; else accessoryHtml += cardHtml;
                (d.mainStats || []).forEach(ms => { let v = parseFloat(ms.value || 0) + parseFloat(ms.extra || 0); let e = getEntry(ms.name); e.equipMain += v; e.detailGroups.base.push(`+${i.enchantLevel} ${d.name}: +${v}`); });
                (d.subStats || []).forEach(ss => { if (!ss.value) return; let k = ss.value.toString().includes('%') ? ss.name + '%' : ss.name; let v = parseFloat(ss.value.toString().replace('%', '')) || 0; let e = getEntry(k); e.equipSub += v; e.detailGroups.random.push(`${d.name}: +${ss.value}`); });
                (d.magicStoneStat || []).forEach(ms => { if (!ms.value) return; let k = ms.value.toString().includes('%') ? ms.name + '%' : ms.name; let v = parseFloat(ms.value.toString().replace('%', '')) || 0; let e = getEntry(k); e.equipSub += v; e.detailGroups.stone.push(`${d.name}: ${ms.value}`); });
            }
        });

        document.getElementById('equip-armor-list').innerHTML = armorHtml || "<div>ç„¡è³‡æ–™</div>";
        document.getElementById('equip-accessory-list').innerHTML = accessoryHtml || "<div>ç„¡è³‡æ–™</div>";
        renderSkills(data, boardSkillMap, cardSkillMap);
        renderStatTable(stats);
    }

    function renderRankings(rankList) {
        const container = document.getElementById('p-ranking-container');
        container.innerHTML = "";
        rankList.forEach(r => {
            if (!r.rank) return;
            let changeHtml = r.rankChange > 0 ? `<span class="rank-change up">â–²${r.rankChange}</span>` : (r.rankChange < 0 ? `<span class="rank-change down">â–¼${Math.abs(r.rankChange)}</span>` : "");
            container.innerHTML += `<div class="rank-badge"><img src="${r.gradeIcon}" alt="${r.gradeName}"><div class="rank-info"><span class="rank-title">${r.rankingContentsName} [${r.gradeName}]</span><span class="rank-val">${r.rank} ä½ ${changeHtml}</span></div></div>`;
        });
    }

    function renderSkills(data, boardSkillMap, cardSkillMap) {
        let act = "", pas = "", sti = "";
        data.skill.skillList.forEach(s => {
            let bLv = boardSkillMap[s.name] || 0;
            let cLv = (cardSkillMap[s.name] || []).reduce((a, b) => a + b.lv, 0);
            let tip = `<div class="tooltip"><b>${s.name}</b><br>åŸºç¤: Lv.${Math.max(0, s.skillLevel - bLv - cLv)}<br>æ¿å¡Š: +${bLv}<br>å¡ç‰‡: +${cLv}</div>`;
            let h = `<div class="skill-card"><img src="${getCorrectIcon(s.icon)}"><div><span class="sk-name">${s.name}</span><span style="color:var(--blue);font-size:14px">Lv.${s.skillLevel}</span></div>${tip}</div>`;
            if (s.category === "Active") act += h; else if (s.category === "Passive") pas += h; else sti += h;
        });
        document.getElementById('sk-act').innerHTML = act; document.getElementById('sk-pas').innerHTML = pas; document.getElementById('sk-stigma').innerHTML = sti;
    }

    function renderStatTable(stats) {
        document.getElementById('stat-body').innerHTML = Object.keys(stats).sort().map(k => {
            const d = stats[k];
            const sum = d.nezakan + d.zikel + d.baizel + d.triniel + d.ariel + d.asphel + d.equipMain + d.equipSub + d.other;
            if (sum === 0) return '';
            const fmt = (v) => v === 0 ? '--' : (Math.round(v * 100) / 100 + (d.isPerc ? '%' : ''));
            const makeGroup = (title, items, color) => items.length === 0 ? "" : `<div style="margin-top:6px;"><b style="color:${color}; border-bottom:1px solid rgba(255,255,255,0.2); display:block; margin-bottom:2px;">${title}</b>${items.map(i => `<div style="font-size:11px; color:#eee; padding-left:5px;">â–¹ ${i}</div>`).join('')}</div>`;
            let tooltip = `<b style="font-size:14px; color:var(--gold); border-bottom:2px solid var(--gold); display:block; margin-bottom:5px;">${k} ä¾†æºå°å¸³è¡¨</b>`;
            tooltip += makeGroup("ğŸ›¡ï¸ åŸºç¤å±¬æ€§èˆ‡å¼·åŒ–", d.detailGroups.base, "var(--blue)");
            tooltip += makeGroup("ğŸ’ ç£¨çŸ³é‘²åµŒ", d.detailGroups.stone, "var(--gold)");
            tooltip += makeGroup("âœ¨ éš¨æ©Ÿåˆ»å°", d.detailGroups.random, "var(--green)");
            tooltip += makeGroup("ğŸ–ï¸ ç¨±è™ŸåŠ æˆ", d.detailGroups.title, "var(--nezakan)");
            tooltip += makeGroup("ğŸ´ è–ç‰©/å…¶ä»–", d.detailGroups.arcana.concat(d.detailGroups.etc), "var(--arcana)");
            const cell = (val) => val === 0 ? '<td>--</td>' : `<td><div class="hover-calc">${fmt(val)}<div class="tooltip">${tooltip}</div></div></td>`;
            return `<tr><td class="td-left">${k}</td><td>${fmt(d.nezakan)}</td><td>${fmt(d.zikel)}</td><td>${fmt(d.baizel)}</td><td>${fmt(d.triniel)}</td><td>${fmt(d.ariel)}</td><td>${fmt(d.asphel)}</td>${cell(d.equipMain)}${cell(d.equipSub)}${cell(d.other)}<td style="color:var(--green);font-weight:bold;">+${Math.round(sum * 100) / 100}${d.isPerc ? '%' : ''}</td></tr>`;
        }).join('');
    }

</script>
</body>
</html>